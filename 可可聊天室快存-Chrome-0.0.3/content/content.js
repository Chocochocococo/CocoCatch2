/****************************
 * content.js - Áµ±‰∏ÄÁâàÊú¨
 * ÂåÖÂê´ÊâÄÊúâÂπ≥Âè∞ÁöÑËôïÁêÜÈÇèËºØ
 ****************************/

(async function () {
  console.log('üöÄ ËÅäÂ§©ÂÆ§ÂåØÂá∫Â∑•ÂÖ∑ÂïüÂãï‰∏≠...');
  const defaultUserAvatar = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAxXpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjabVDbDcMgDPxnio4AtgF7HNKkUjfo+D1iJ0qqnsT5hc6PtH3er/SYoCJJatdmrWVATIwGHM2OsXPJsvMOiRLiWz6dBUKKYdlDbfH/yJdTwM2AVy9C+ozCci9YdCD9EYpGPCciOGsIWQgxeaGEwPC1cjPt1xWWLd+h/tKkfqxhbn9j6bjeWtGHiTYunMHM6gPwfDXxgMNgZpwDnwx+ZdmZYhIc5N+dDqQv625ZL0IJTyYAAAGEaUNDUElDQyBwcm9maWxlAAB4nH2RPUjDQBzFX1OlohUHO4gIZqhOdlGRjqWKRbBQ2gqtOphc+gVNGpIUF0fBteDgx2LVwcVZVwdXQRD8AHEXnBRdpMT/JYUWMR4c9+PdvcfdO0BoVplq9sQAVbOMdCIu5vKrYuAVfoxjABFEJWbqycxiFp7j6x4+vt5FeJb3uT/HoFIwGeATiWNMNyziDeK5TUvnvE8cYmVJIT4nnjLogsSPXJddfuNccljgmSEjm54nDhGLpS6Wu5iVDZV4ljisqBrlCzmXFc5bnNVqnbXvyV8YLGgrGa7THEMCS0giBREy6qigCov6qkAjxUSa9uMe/lHHnyKXTK4KGDkWUIMKyfGD/8Hvbs3izLSbFIwDvS+2/TEBBHaBVsO2v49tu3UC+J+BK63jrzWB6CfpjY4WPgKGtoGL644m7wGXO8DIky4ZkiP5aQrFIvB+Rt+UB4Zvgf41t7f2Pk4fgCx1tXwDHBwCkyXKXvd4d193b/+eaff3Ayz0cvFgq+bJAAANdmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNC40LjAtRXhpdjIiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iCiAgICB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIgogICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICAgeG1sbnM6R0lNUD0iaHR0cDovL3d3dy5naW1wLm9yZy94bXAvIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgIHhtcE1NOkRvY3VtZW50SUQ9ImdpbXA6ZG9jaWQ6Z2ltcDphODY3NDk0YS0xZTNhLTQ1OWUtOWUwZi03ZWE1NWZhMTNlZDAiCiAgIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ZjVlM2M5OWQtMzY0Yy00NTY5LWI5YTgtMjJiNjQ1YjQ4Yzk3IgogICB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YjJhYWFhZjktMjYwOC00YTgyLTk0M2UtMWIyN2QwYTY3ZTIwIgogICBkYzpGb3JtYXQ9ImltYWdlL3BuZyIKICAgR0lNUDpBUEk9IjIuMCIKICAgR0lNUDpQbGF0Zm9ybT0iV2luZG93cyIKICAgR0lNUDpUaW1lU3RhbXA9IjE3NDM0MjIwOTQyMDAxMzAiCiAgIEdJTVA6VmVyc2lvbj0iMi4xMC4zOCIKICAgdGlmZjpPcmllbnRhdGlvbj0iMSIKICAgeG1wOkNyZWF0b3JUb29sPSJHSU1QIDIuMTAiCiAgIHhtcDpNZXRhZGF0YURhdGU9IjIwMjU6MDM6MzFUMTk6NTQ6NTIrMDg6MDAiCiAgIHhtcDpNb2RpZnlEYXRlPSIyMDI1OjAzOjMxVDE5OjU0OjUyKzA4OjAwIj4KICAgPHhtcE1NOkhpc3Rvcnk+CiAgICA8cmRmOlNlcT4KICAgICA8cmRmOmxpCiAgICAgIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiCiAgICAgIHN0RXZ0OmNoYW5nZWQ9Ii8iCiAgICAgIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6ZTJiODQ0YzktZWM5Mi00NTI2LThlZGQtNDE4ZDU4YmUyZDNmIgogICAgICBzdEV2dDpzb2Z0d2FyZUFnZW50PSJHaW1wIDIuMTAgKFdpbmRvd3MpIgogICAgICBzdEV2dDp3aGVuPSIyMDI1LTAzLTMxVDE5OjU0OjU0Ii8+CiAgICA8L3JkZjpTZXE+CiAgIDwveG1wTU06SGlzdG9yeT4KICA8L3JkZjpEZXNjcmlwdGlvbj4KIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAKPD94cGFja2V0IGVuZD0idyI/PpTBwPcAAAAGYktHRAD+AP4A/usY1IIAAAAJcEhZcwAAAdgAAAHYAfpcpnIAAAAHdElNRQfpAx8LNjb4tjb+AAAK9ElEQVR42s2beZAV1RXGfzNOEFkVJ2JAo1GIoKhAdOQyGBUj4EIS14hIXVFIdGI0iWhMu0SU3GiVQEQtS8GSW0bURFyCpoJJlaJAD1FiqaAIGaBUUAEBWQIRHfJHf42dl7f1e29mOFVdXfPmbufcc8/yndtVtDCFPugOnAwcC3wb6A0cCHQFOgHVwBZgJ7AGWA00Af8AXjPWfdCS66tqIabrgEuAYUDfHM02A/8GmoGOQAdg3yztVgB/Bp4D5hvrdu+VAgh90AW4ErhCOx3Tu8A84HVgOfCesW5djjEOBg6X0OoAAxyXWOcK4GFgurFu414hgNAHBwLXAQ1S691AI/AYMNtY93GZ4/cEzgEuBYbo563AvcAUY92nbSKA0AfVwDjA6Uz/B/DAZGPd8hY6Wn2BnwGX67hsBH4NzDDWNbeaAEIf9AYeBU4CvgQeAiYZ69bS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";
  const defaultAssistantAvatar = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAxXpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjabVDbDcMgDPxnio4AtgF7HNKkUjfo+D1iJ0qqnsT5hc6PtH3er/SYoCJJatdmrWVATIwGHM2OsXPJsvMOiRLiWz6dBUKKYdlDbfH/yJdTwM2AVy9C+ozCci9YdCD9EYpGPCciOGsIWQgxeaGEwPC1cjPt1xWWLd+h/tKkfqxhbn9j6bjeWtGHiTYunMHM6gPwfDXxgMNgZpwDnwx+ZdmZYhIc5N+dDqQv625ZL0IJTyYAAAGEaUNDUElDQyBwcm9maWxlAAB4nH2RPUjDQBzFX1OlohUHO4gIZqhOdlGRjqWKRbBQ2gqtOphc+gVNGpIUF0fBteDgx2LVwcVZVwdXQRD8AHEXnBRdpMT/JYUWMR4c9+PdvcfdO0BoVplq9sQAVbOMdCIu5vKrYuAVfoxjABFEJWbqycxiFp7j6x4+vt5FeJb3uT/HoFIwGeATiWNMNyziDeK5TUvnvE8cYmVJIT4nnjLogsSPXJddfuNccljgmSEjm54nDhGLpS6Wu5iVDZV4ljisqBrlCzmXFc5bnNVqnbXvyV8YLGgrGa7THEMCS0giBREy6qigCov6qkAjxUSa9uMe/lHHnyKXTK4KGDkWUIMKyfGD/8Hvbs3izLSbFIwDvS+2/TEBBHaBVsO2v49tu3UC+J+BK63jrzWB6CfpjY4WPgKGtoGL644m7wGXO8DIky4ZkiP5aQrFIvB+Rt+UB4Zvgf41t7f2Pk4fgCx1tXwDHBwCkyXKXvd4d193b/+eaff3Ayz0cvFgq+bJAAANdmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNC40LjAtRXhpdjIiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iCiAgICB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIgogICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICAgeG1sbnM6R0lNUD0iaHR0cDovL3d3dy5naW1wLm9yZy94bXAvIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgIHhtcE1NOkRvY3VtZW50SUQ9ImdpbXA6ZG9jaWQ6Z2ltcDphODY3NDk0YS0xZTNhLTQ1OWUtOWUwZi03ZWE1NWZhMTNlZDAiCiAgIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ZjVlM2M5OWQtMzY0Yy00NTY5LWI5YTgtMjJiNjQ1YjQ4Yzk3IgogICB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YjJhYWFhZjktMjYwOC00YTgyLTk0M2UtMWIyN2QwYTY3ZTIwIgogICBkYzpGb3JtYXQ9ImltYWdlL3BuZyIKICAgR0lNUDpBUEk9IjIuMCIKICAgR0lNUDpQbGF0Zm9ybT0iV2luZG93cyIKICAgR0lNUDpUaW1lU3RhbXA9IjE3NDM0MjIwOTQyMDAxMzAiCiAgIEdJTVA6VmVyc2lvbj0iMi4xMC4zOCIKICAgdGlmZjpPcmllbnRhdGlvbj0iMSIKICAgeG1wOkNyZWF0b3JUb29sPSJHSU1QIDIuMTAiCiAgIHhtcDpNZXRhZGF0YURhdGU9IjIwMjU6MDM6MzFUMTk6NTQ6NTIrMDg6MDAiCiAgIHhtcDpNb2RpZnlEYXRlPSIyMDI1OjAzOjMxVDE5OjU0OjUyKzA4OjAwIj4KICAgPHhtcE1NOkhpc3Rvcnk+CiAgICA8cmRmOlNlcT4KICAgICA8cmRmOmxpCiAgICAgIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiCiAgICAgIHN0RXZ0OmNoYW5nZWQ9Ii8iCiAgICAgIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6ZTJiODQ0YzktZWM5Mi00NTI2LThlZGQtNDE4ZDU4YmUyZDNmIgogICAgICBzdEV2dDpzb2Z0d2FyZUFnZW50PSJHaW1wIDIuMTAgKFdpbmRvd3MpIgogICAgICBzdEV2dDp3aGVuPSIyMDI1LTAzLTMxVDE5OjU0OjU0Ii8+CiAgICA8L3JkZjpTZXE+CiAgIDwveG1wTU06SGlzdG9yeT4KICA8L3JkZjpEZXNjcmlwdGlvbj4KIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAKPD94cGFja2V0IGVuZD0idyI/PpTBwPcAAAAGYktHRAD+AP4A/usY1IIAAAAJcEhZcwAAAdgAAAHYAfpcpnIAAAAHdElNRQfpAx8LNjb4tjb+AAAK9ElEQVR42s2beZAV1RXGfzNOEFkVJ2JAo1GIoKhAdOQyGBUj4EIS14hIXVFIdGI0iWhMu0SU3GiVQEQtS8GSW0bURFyCpoJJlaJAD1FiqaAIGaBUUAEBWQIRHfJHf42dl7f1e29mOFVdXfPmbufcc8/yndtVtDCFPugOnAwcC3wb6A0cCHQFOgHVwBZgJ7AGWA00Af8AXjPWfdCS66tqIabrgEuAYUDfHM02A/8GmoGOQAdg3yztVgB/Bp4D5hvrdu+VAgh90AW4ErhCOx3Tu8A84HVgOfCesW5djjEOBg6X0OoAAxyXWOcK4GFgurFu414hgNAHBwLXAQ1S691AI/AYMNtY93GZ4/cEzgEuBYbo563AvcAUY92nbSKA0AfVwDjA6Uz/B/DAZGPd8hY6Wn2BnwGX67hsBH4NzDDWNbeaAEIf9AYeBU4CvgQeAiYZ69bS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";
    // Ê™¢Êü•ÂøÖË¶ÅÁöÑÊ®°ÁµÑÊòØÂê¶ËºâÂÖ•
  function checkRequiredModules() {
    const required = {
      'marked': typeof marked !== 'undefined',
      'TurndownService': typeof TurndownService !== 'undefined',
      'html2canvas': typeof html2canvas !== 'undefined',
      'JSZip': typeof JSZip !== 'undefined',
      'utils': typeof window.utils !== 'undefined',
      'imageModule': typeof window.imageModule !== 'undefined',
      'markdownModule': typeof window.markdownModule !== 'undefined',
      'sillyModule': typeof window.sillyModule !== 'undefined'
    };

    const missing = Object.entries(required)
      .filter(([name, loaded]) => !loaded)
      .map(([name]) => name);

    if (missing.length > 0) {
      console.error('‚ùå Áº∫Â∞ëÂøÖË¶ÅÊ®°ÁµÑ:', missing);
      return false;
    }
    return true;
  }

  // Á≠âÂæÖÊ®°ÁµÑËºâÂÖ•
  async function waitForModules(maxAttempts = 20) {
    for (let i = 0; i < maxAttempts; i++) {
      if (checkRequiredModules()) {
        console.log('‚úÖ ÊâÄÊúâÂøÖË¶ÅÊ®°ÁµÑÂ∑≤ËºâÂÖ•');
        return true;
      }
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    console.error('‚ùå Ê®°ÁµÑËºâÂÖ•Ë∂ÖÊôÇ');
    return false;
  }

  // ÂåØÂá∫ËôïÁêÜÈÇèËºØÔºàÊï¥ÂêàËá™background.jsÔºâ
  async function handleExport(conversationData, settings) {
    console.log("ÈñãÂßãËôïÁêÜÂåØÂá∫...");
    
    const selectedMessages = conversationData.filter(m => m.selected);
    if (!selectedMessages.length) {
      console.error("Ê≤íÊúâ‰ªª‰ΩïÂ∑≤ÂãæÈÅ∏ÁöÑË®äÊÅØÔºÅ");
      throw new Error("Ê≤íÊúâÈÅ∏‰∏≠ÁöÑË®äÊÅØ");
    }
    
    const fileName = (settings.fileNameBase || "export").replace(/[\/\\?%*:|"<>]/g, "_");

    try {
      switch(settings.storedFormat) {
        case "image": {
          let dataURL;
          if (settings.storedScreenshotStyle === "bubble") {
            dataURL = await window.imageModule.generateChatImageBubble(selectedMessages, {
              splitMode: settings.splitMode,
              maxHeight: settings.maxHeight,
              useMarkdown: true,
              userMsgBgColor: settings.storedUserMsgBgColor,
              assistantMsgBgColor: settings.storedAssistantMsgBgColor,
              userAvatar: settings.storedUserAvatar,
              assistantAvatar: settings.storedAssistantAvatar,
              imageWidth: settings.storedImageWidth,
              fontSize: settings.storedFontSize,
              fontColor: settings.storedFontColor,
              backgroundColor: settings.storedBackgroundColor,
              fontFamily: settings.storedFontFamily
            });
          } else {
            dataURL = await window.imageModule.generateChatImageLeft(selectedMessages, {
              splitMode: settings.splitMode,
              maxHeight: settings.maxHeight,
              useMarkdown: true,
              userMsgBgColor: settings.storedUserMsgBgColor,
              assistantMsgBgColor: settings.storedAssistantMsgBgColor,
              userAvatar: settings.storedUserAvatar,
              assistantAvatar: settings.storedAssistantAvatar,
              imageWidth: settings.storedImageWidth,
              fontSize: settings.storedFontSize,
              fontColor: settings.storedFontColor,
              backgroundColor: settings.storedBackgroundColor,
              fontFamily: settings.storedFontFamily
            });
          }
          
          if (Array.isArray(dataURL)) {
            // Â§öÂºµÂúñÁâáÔºåÊâìÂåÖÊàêZIP
            const zip = new JSZip();
            let idx = 1;
            for (const url of dataURL) {
              const blob = window.utils.imageDataURLToBlob(url);
              zip.file(fileName + "-" + (idx++) + ".png", blob);
            }
            const zipBlob = await zip.generateAsync({ type: "blob" });
            await downloadFile(zipBlob, fileName + ".zip", "application/zip");
          } else {
            // ÂñÆÂºµÂúñÁâá
            const blob = window.utils.imageDataURLToBlob(dataURL);
            await downloadFile(blob, fileName + ".png", "image/png");
          }
          break;
        }
        
        case "markdown": {
          const mdContent = window.markdownModule.convertToMD(selectedMessages, settings.storedUserName, settings.storedCharacterName);
          const blob = new Blob([mdContent], { type: "text/markdown" });
          await downloadFile(blob, fileName + ".md", "text/markdown");
          break;
        }
        
        case "silly": {
          const sillyContent = window.sillyModule.convertToSillyTavernJSONL(selectedMessages, settings.storedUserName, settings.storedCharacterName);
          const blob = new Blob([sillyContent], { type: "application/json" });
          await downloadFile(blob, fileName + ".jsonl", "application/json");
          break;
        }
        
        case "text":
        default: {
          const txtContent = window.utils.convertToTXT(selectedMessages, settings.storedUserName, settings.storedCharacterName);
          const blob = new Blob([txtContent], { type: "text/plain" });
          await downloadFile(blob, fileName + ".txt", "text/plain");
          break;
        }
      }
      
      console.log("ÂåØÂá∫ÂÆåÊàêÔºÅ");
      return { ok: true, msg: "ÂåØÂá∫ËôïÁêÜÂÆåÊàê" };
      
    } catch (err) {
      console.error("ÂåØÂá∫ÈÅéÁ®ãÁôºÁîüÈåØË™§Ôºö", err);
      throw err;
    }
  }

  // ‰∏ãËºâÊ™îÊ°àÂäüËÉΩ
  async function downloadFile(blob, filename, contentType) {
    try {
      // ÊñπÊ≥ï1: ÂòóË©¶‰ΩøÁî®Chrome Downloads API
      if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            chrome.runtime.sendMessage({
              type: "DOWNLOAD_FILE",
              payload: { 
                dataUrl: reader.result,
                filename: filename 
              }
            }, (response) => {
              if (response && response.ok) {
                resolve();
              } else {
                // Â¶ÇÊûúAPIÂ§±ÊïóÔºåfallbackÂà∞Áõ¥Êé•‰∏ãËºâ
                directDownload(blob, filename);
                resolve();
              }
            });
          };
          reader.onerror = () => {
            directDownload(blob, filename);
            resolve();
          };
          reader.readAsDataURL(blob);
        });
      } else {
        // ÊñπÊ≥ï2: Áõ¥Êé•‰∏ãËºâ
        directDownload(blob, filename);
      }
    } catch (err) {
      console.warn("API‰∏ãËºâÂ§±ÊïóÔºå‰ΩøÁî®Áõ¥Êé•‰∏ãËºâ:", err);
      directDownload(blob, filename);
    }
  }

  // Áõ¥Êé•‰∏ãËºâÔºàfallbackÊñπÊ≥ïÔºâ
  function directDownload(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
  }

  // Áõ£ËÅΩ‰æÜËá™backgroundÁöÑÊ∂àÊÅØ
  if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.onMessage) {
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      if (message.type === "HANDLE_EXPORT") {
        const { conversationData, settings } = message.payload;
        handleExport(conversationData, settings)
          .then(result => sendResponse(result))
          .catch(err => sendResponse({ ok: false, msg: "ËôïÁêÜÂ§±Êïó", error: err.message }));
        return true; // Áï∞Ê≠•ÈüøÊáâ
      }
    });
  }
  
  // Âπ≥Âè∞ÂÅµÊ∏¨
  function detectPlatform() {
    const hostname = window.location.hostname;
    
    if (hostname.includes('chatgpt.com')) return 'chatgpt';
    if (hostname.includes('gemini.google.com')) return 'gemini';
    if (hostname.includes('chat.mistral.ai')) return 'mistral';
    
    return null;
  }

  // Á≠âÂæÖÂπ≥Âè∞ËºâÂÖ•
  function waitForPlatform(maxAttempts = 30, interval = 500) {
    return new Promise((resolve) => {
      let attempts = 0;
      const checkInterval = setInterval(() => {
        attempts++;
        const platform = detectPlatform();
        
        if (platform || attempts >= maxAttempts) {
          clearInterval(checkInterval);
          resolve(platform);
        }
      }, interval);
    });
  }

  // ChatGPT ÂàùÂßãÂåñÈÇèËºØ
  async function initChatGPT() {
    console.log('ü§ñ ÂàùÂßãÂåñ ChatGPT ÂåØÂá∫Â∑•ÂÖ∑');
    
    const storedData = await chrome.storage.local.get({
        storedFormat: "text",
        storedUserName: "‰Ω†",
        storedCharacterName: "ChatGPT",
        storedImageWidth: 800,
        storedFontSize: 16,
        storedFontColor: "#ffffff",
        storedBackgroundColor: "#000000",
        storedFontFamily: "Êñ∞Á¥∞ÊòéÈ´î",
        storedUserAvatar: "",
        storedAssistantAvatar: "",
        storedScreenshotStyle: "left",
        storedUserMsgBgColor: "#313131",
        storedAssistantMsgBgColor: "#202020"
      });
      let storedFormat = storedData.storedFormat;
      let storedUserName = storedData.storedUserName;
      let storedCharacterName = storedData.storedCharacterName;
      let storedImageWidth = storedData.storedImageWidth;
      let storedFontSize = storedData.storedFontSize;
      let storedFontColor = storedData.storedFontColor;
      let storedBackgroundColor = storedData.storedBackgroundColor;
      let storedFontFamily = storedData.storedFontFamily;
      let storedUserAvatar = storedData.storedUserAvatar;
      let storedAssistantAvatar = storedData.storedAssistantAvatar;
      let storedScreenshotStyle = storedData.storedScreenshotStyle;
      let storedUserMsgBgColor = storedData.storedUserMsgBgColor;
      let storedAssistantMsgBgColor = storedData.storedAssistantMsgBgColor;

      let selectionModeEnabled = false;
      let conversationData = [];
      let currentUrl = window.location.pathname;

      function generateId() {
        return '_' + Math.random().toString(36).substr(2, 9);
      }

      // <<< MODIFIED >>> Âêà‰Ωµ‰∫ÜÊñ∞ËàäÁâàÁöÑÈÇèËºØ
      // ÈÄôÂÄãÂáΩÂºèÁèæÂú®Ë≤†Ë≤¨Âú®ÈúÄË¶ÅÊôÇÈáçÁΩÆÁãÄÊÖã
      function checkIfChatChanged() {
        if (window.location.pathname !== currentUrl) {
          console.log("URL change detected. Resetting conversation data.");
          currentUrl = window.location.pathname;
          conversationData = []; // Âº∑Âà∂Ê∏ÖÁ©∫ËàäË≥áÊñô
          
          // ÁßªÈô§ÊâÄÊúâËàäÁöÑÂãæÈÅ∏Ê°ÜÔºåÈÅøÂÖçÊÆòÁïô
          document.querySelectorAll(".chat-export-checkbox").forEach(cb => cb.remove());
          
          // ÁßªÈô§ËàäÁöÑÊ®ôË®òÔºåÁ¢∫‰øùËÉΩÈáçÊñ∞ÊéÉÊèè
          const allArticles = document.querySelectorAll("article[data-testid^='conversation-turn']");
          allArticles.forEach(art => art.removeAttribute("data-exported"));
        }
      }

      // ÈÄôÂÄãÂáΩÂºèË≤†Ë≤¨ÊéÉÊèè‰∏¶ËàáÁï∂Ââç DOM ÂêåÊ≠•Â∞çË©±
      async function scanConversation() {
        // ÊØèÊ¨°ÊéÉÊèèÂâçÈÉΩÊ™¢Êü• URL ÊòØÂê¶ËÆäÊõ¥ÔºåÈÄôÊúÉËôïÁêÜËÅäÂ§©ÂÆ§ÂàáÊèõ
        checkIfChatChanged(); 

        // 1. Áç≤ÂèñÁï∂ÂâçÈ†ÅÈù¢‰∏äÊâÄÊúâÂ∞çË©± article ÂÖÉÁ¥†
        const currentArticles = Array.from(document.querySelectorAll("article[data-testid^='conversation-turn']"));
        const currentArticleSet = new Set(currentArticles);

        // 2.„ÄêÈóúÈçµ„ÄëÊ∏ÖÁêÜ conversationDataÔºöÁßªÈô§ÊâÄÊúâÂú®Áï∂ÂâçÈ†ÅÈù¢‰∏äÂ∑≤‰∏çÂ≠òÂú®ÁöÑ DOM ÂÖÉÁ¥†Â∞çÊáâÁöÑË≥áÊñô
        //    ÈÄô‰∏ÄÊ≠•ÊúÉËá™ÂãïËôïÁêÜÊéâ„ÄåË¢´ÈáçÊñ∞ÁîüÊàê„ÄçÁöÑËàäË®äÊÅØ„ÄÇ
        conversationData = conversationData.filter(msg => currentArticleSet.has(msg.element));

        // Âª∫Á´ã‰∏ÄÂÄãÁï∂ÂâçÂ∑≤Â≠òË≥áÊñôÁöÑ SetÔºåÊñπ‰æøÂø´ÈÄüÊü•Êâæ
        const existingElementsInConvData = new Set(conversationData.map(msg => msg.element));

        // 3. Êñ∞Â¢ûÊñ∞Ë®äÊÅØÔºöÈÅçÊ≠∑Áï∂ÂâçÈ†ÅÈù¢‰∏äÁöÑ articleÔºåÂ¶ÇÊûúÂÆÉ‰∏çÂ≠òÂú®ÊñºÊàëÂÄëÂ∑≤ÊúâÁöÑË≥áÊñô‰∏≠ÔºåÂ∞±Êñ∞Â¢ûÂÆÉ
        for (const article of currentArticles) {
          if (!existingElementsInConvData.has(article)) {
            // ÈÄôÊòØ‰∏ÄÂÄãÂÖ®Êñ∞ÁöÑË®äÊÅØÔºåËôïÁêÜ‰∏¶Âä†ÂÖ•
            const cloned = article.cloneNode(true);
            cloned.querySelectorAll("h5.sr-only, h6.sr-only").forEach(el => el.remove());
            
            const roleContainer = cloned.querySelector("div[data-message-author-role]");
            const role = roleContainer ? roleContainer.getAttribute("data-message-author-role") : "assistant";
            const finalText = cloned.innerText.trim();

            const newMessageData = {
              id: generateId(),
              role,
              text: finalText,
              markdown: getMarkdownFromMessage(cloned, role === "user"),
              element: article, // ‰øùÁïôÂ∞çÁúüÂØ¶ DOM ÁöÑÂºïÁî®
              selected: true
            };
            conversationData.push(newMessageData);
          }
        }

        // ÂèØÈÅ∏ÔºöÊ†πÊìö DOM È†ÜÂ∫èÊéíÂ∫èÔºåÁ¢∫‰øùË≥áÊñôÈ†ÜÂ∫èÊ≠£Á¢∫
        conversationData.sort((a, b) => {
            const position = a.element.compareDocumentPosition(b.element);
            if (position & Node.DOCUMENT_POSITION_FOLLOWING) return -1;
            if (position & Node.DOCUMENT_POSITION_PRECEDING) return 1;
            return 0;
        });

        // Â¶ÇÊûúËôïÊñºÈÅ∏ÊìáÊ®°ÂºèÔºåÁÇ∫Êñ∞ÊéÉÊèèÂà∞ÁöÑË®äÊÅØÂä†‰∏äÂãæÈÅ∏Ê°Ü
        if (selectionModeEnabled) {
          conversationData.forEach(msg => {
            if (!msg.element.querySelector(".chat-export-checkbox")) {
              addCheckboxToMessage(msg.element, msg.id);
            }
          });
        }
      }

      /***************** Â∑•ÂÖ∑ÔºöÂÆâÂÖ®ËΩâÁæ© *****************/
      function escapeHTML(str) {
        return str.replace(/[&<>"']/g, (m) =>
          ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])
        );
      }

      /***************** ÊääË®äÊÅØËΩâÊàê Markdown *****************/
      function getMarkdownFromMessage(el, isUser) {
        // ü§ñ GPT ÊàñÁ≥ªÁµ±Ë®äÊÅØ ‚Üí ÁÖßËàä Turndown
        if (!isUser) return turndownService.turndown(el.innerHTML);

        // üßç‚Äç‚ôÄÔ∏è ‰ΩøÁî®ËÄÖË®äÊÅØ ‚Üí Áõ¥Êé•ÊãøÁ¥îÊñáÂ≠ó„ÄÅËá™Â∑±ÊèíÂÖ©Á©∫Ê†ºÊèõË°å
        const raw = el.textContent || "";
        return raw
          .split("\n")                     // ÊåâÁúüÂØ¶ÊèõË°åÂàá
          .map(line => line.trimEnd())     // ÂéªÊéâË°åÂ∞æÂ§öÈ§òÁ©∫ÁôΩ
          .join("  \n");                   // Markdown ÁöÑ <br>ÔºùÂÖ©Á©∫Ê†º+LF
      }


      const turndownService = new TurndownService();
      if (typeof turndownPluginGfm !== "undefined" && turndownPluginGfm.gfm) {
        turndownService.use(turndownPluginGfm.gfm);
      }
      turndownService.addRule('strikethrough', {
        filter: ['del', 's', 'strike'],
        replacement: function(content) {
          return '~~' + content + '~~';
        }
      });
      turndownService.addRule('gptMultilineCode', {
        filter: function (node) {
          return (
            node.nodeName === 'CODE' &&
            node.className.includes('whitespace-pre') &&
            node.textContent.includes('\n')
          );
        },
        replacement: function (content, node) {
          const langClass = [...node.classList].find(c => c.startsWith('language-'));
          const lang = langClass ? langClass.replace('language-', '') : '';
          return `\n\n\`\`\`${lang}\n${node.textContent}\n\`\`\`\n\n`;
        }
      });

      /*****************************************
       * Ê≥®ÂÖ•ÊéßÂà∂Èù¢ÊùøÂà∞ÊåáÂÆö‰ΩçÁΩÆ (Âè™Ë≤†Ë≤¨ UI)
       *****************************************/
      let container = document.getElementById("chatgpt-exporter-container");
      if (!container) {
        container = document.createElement("div");
        container.id = "chatgpt-exporter-container";
        container.style.position = "fixed";
        container.style.right = "100px"; 
        container.style.bottom = "25px"; 
        container.style.zIndex = 9999;
        document.body.appendChild(container);
      }
      container.innerHTML = "";
      container.style.display = "flex";
      container.style.flexDirection = "column";
      container.style.gap = "4px";
      
      // ÂÖ®ÂüüÈÅ∏ÊìáË®≠ÂÆö
      let storedFilter = "all";

      /********************
       * Á¨¨‰∏ÄÊéíÔºöSelect row
       ********************/
      const selectRow = document.createElement("div");
      selectRow.style.display = "flex";
      selectRow.style.alignItems = "center";
      selectRow.style.gap = "4px";

      // „ÄåSelect„ÄçÊåâÈàï
      const fixedButtonStyle = {
        width: "80px",
        backgroundColor: "#444",
        color: "#fff",
        border: "none",
        borderRadius: "4px",
        padding: "4px 8px",
        cursor: "pointer"
      };

      const selectBtn = document.createElement("button");
        selectBtn.textContent = "Select";
        Object.assign(selectBtn.style, fixedButtonStyle);
        selectBtn.addEventListener("click", async () => {
          selectionModeEnabled = !selectionModeEnabled;
        
          if (selectionModeEnabled) {
            await scanConversation();
            conversationData.forEach(msg => {
              addCheckboxToMessage(msg.element, msg.id);
            });
            globalSelectChk.style.display = "inline-block";
            globalSelectChk.style.position = "absolute";
            globalSelectChk.style.right = "8px";
            globalSelectChk.style.top = "5px";
        
            if (storedFilter === "all") {
              conversationData.forEach(m => (m.selected = true));
              document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
                cb.checked = true;
              });
              globalSelectChk.checked = true;
            } else if (storedFilter === "user") {
              conversationData.forEach(m => (m.selected = (m.role === "user")));
              document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
                const msgId = cb.getAttribute("data-msg-id");
                const msg = conversationData.find(m => m.id === msgId);
                cb.checked = msg && msg.role === "user";
              });
              globalSelectChk.checked = false;
            } else if (storedFilter === "assistant") {
              conversationData.forEach(m => (m.selected = (m.role === "assistant")));
              document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
                const msgId = cb.getAttribute("data-msg-id");
                const msg = conversationData.find(m => m.id === msgId);
                cb.checked = msg && msg.role === "assistant";
              });
              globalSelectChk.checked = false;
            }
          } else {
            document.querySelectorAll(".chat-export-checkbox").forEach(cb => cb.remove());
            globalSelectChk.style.display = "none";
          }
        });
      selectRow.appendChild(selectBtn);

      const selectDropdownBtn = document.createElement("button");
      selectDropdownBtn.textContent = "‚ñæ";
      selectDropdownBtn.style.width = "25px";
      selectDropdownBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
      selectDropdownBtn.style.color = fixedButtonStyle.color;
      selectDropdownBtn.style.border = fixedButtonStyle.border;
      selectDropdownBtn.style.borderRadius = fixedButtonStyle.borderRadius;
      selectDropdownBtn.style.padding = "4px 6px";
      selectDropdownBtn.style.cursor = fixedButtonStyle.cursor;
      selectRow.appendChild(selectDropdownBtn);
      // ÂÖ®ÈÅ∏ÂãæÈÅ∏Ê°Ü (ÂÖ®Â±Ä)
      const globalSelectChk = document.createElement("input");
      globalSelectChk.type = "checkbox";
      globalSelectChk.checked = true;
      globalSelectChk.style.display = "none";
      globalSelectChk.addEventListener("change", () => {
        document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
          cb.checked = globalSelectChk.checked;
          const msgId = cb.getAttribute("data-msg-id");
          const msg = conversationData.find(m => m.id === msgId);
          if (msg) msg.selected = globalSelectChk.checked;
        });
      });
      selectRow.appendChild(globalSelectChk);
      // ‰∏ãÊãâÈÅ∏ÂñÆ (Select)
      const selectDropdownMenu = document.createElement("div");
      selectDropdownMenu.style.position = "absolute";
      selectDropdownMenu.style.backgroundColor = "#555";
      selectDropdownMenu.style.border = "1px solid #777";
      selectDropdownMenu.style.borderRadius = "4px";
      selectDropdownMenu.style.padding = "4px";
      selectDropdownMenu.style.bottom = "35px";
      selectDropdownMenu.style.left = "0";
      selectDropdownMenu.style.display = "none";
      const selectOptions = [
        { value: "all", label: "ÂÖ®ÈÅ∏" },
        { value: "user", label: "Âè™ÈÅ∏ user" },
        { value: "assistant", label: "Âè™ÈÅ∏ GPT" }
      ];
      selectOptions.forEach(opt => {
        const optBtn = document.createElement("div");
        optBtn.textContent = opt.label;
        optBtn.style.padding = "4px";
        optBtn.style.cursor = "pointer";
        if (opt.value === storedFilter) {
          optBtn.style.backgroundColor = "#777";
        }
        optBtn.addEventListener("click", () => {
          storedFilter = opt.value;
          Array.from(selectDropdownMenu.children).forEach(child => {
            child.style.backgroundColor = (child.textContent === opt.label ? "#777" : "");
          });
          selectDropdownBtn.textContent = "‚ñæ";
          selectDropdownMenu.style.display = "none";
          
          conversationData.forEach(msg => {
            let newState;
            if (storedFilter === "all") {
              newState = true;
            } else if (storedFilter === "user") {
              newState = (msg.role === "user");
            } else if (storedFilter === "assistant") {
              newState = (msg.role === "assistant");
            }
            msg.selected = newState;
            const chk = msg.element.querySelector(`[data-msg-id="${msg.id}"]`);
            if (chk) {
              chk.checked = newState;
            }
          });
          globalSelectChk.checked = (storedFilter === "all");
        });
        selectDropdownMenu.appendChild(optBtn);
      });
      selectDropdownBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        selectDropdownMenu.style.display = selectDropdownMenu.style.display === "none" ? "block" : "none";
      });
      document.addEventListener("click", () => { selectDropdownMenu.style.display = "none"; });
      selectRow.style.position = "relative";
      selectRow.appendChild(selectDropdownMenu);

      /********************
       * Á¨¨‰∫åÊéíÔºöExport row
       ********************/
      const exportRow = document.createElement("div");
      exportRow.style.display = "flex";
      exportRow.style.alignItems = "center";
      exportRow.style.gap = "4px";

      const exportBtnText = document.createElement("button");
      exportBtnText.textContent = "Export";
      Object.assign(exportBtnText.style, fixedButtonStyle);
      exportBtnText.addEventListener("click", doExport);
      exportRow.appendChild(exportBtnText);

      const exportDropdownBtn = document.createElement("button");
      exportDropdownBtn.textContent = "‚ñæ";
      exportDropdownBtn.style.width = "25px";
      exportDropdownBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
      exportDropdownBtn.style.color = fixedButtonStyle.color;
      exportDropdownBtn.style.border = fixedButtonStyle.border;
      exportDropdownBtn.style.borderRadius = fixedButtonStyle.borderRadius;
      exportDropdownBtn.style.padding = "4px 6px";
      exportDropdownBtn.style.cursor = fixedButtonStyle.cursor;
      exportRow.appendChild(exportDropdownBtn);

      const exportDropdownMenu = document.createElement("div");
      exportDropdownMenu.style.position = "absolute";
      exportDropdownMenu.style.backgroundColor = "#555";
      exportDropdownMenu.style.border = "1px solid #777";
      exportDropdownMenu.style.borderRadius = "4px";
      exportDropdownMenu.style.padding = "4px";
      exportDropdownMenu.style.bottom = "35px";
      exportDropdownMenu.style.left = "0";
      exportDropdownMenu.style.display = "none";

      const formats = [
        { val: "image", label: "IMAGE" },
        { val: "text", label: "TEXT" },
        { val: "markdown", label: "MARKDOWN" },
      // { val: "pdf-html2",label: "PDF (ÂúñÁâá)" },
      // { val: "pdf-lib",  label: "PDF (ÊñáÂ≠ó)" },
        { val: "silly", label: "SILLY" }
      ];
      formats.forEach(fmt => {
        const fmtBtn = document.createElement("div");
        fmtBtn.textContent = fmt.label;
        fmtBtn.style.padding = "4px";
        fmtBtn.style.cursor = "pointer";
        if (fmt.val === storedFormat) {
          fmtBtn.style.backgroundColor = "#777";
        }
        fmtBtn.addEventListener("click", async () => {
          storedFormat = fmt.val;
          await chrome.storage.local.set({ storedFormat });
          Array.from(exportDropdownMenu.children).forEach(child => {
            child.style.backgroundColor = (child.textContent === fmt.label ? "#777" : "");
          });
          exportDropdownBtn.textContent = "‚ñæ";
          exportDropdownMenu.style.display = "none";
        });
        exportDropdownMenu.appendChild(fmtBtn);
      });
      exportDropdownBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        exportDropdownMenu.style.display = exportDropdownMenu.style.display === "none" ? "block" : "none";
      });
      document.addEventListener("click", () => { exportDropdownMenu.style.display = "none"; });
      exportRow.style.position = "relative";
      exportRow.appendChild(exportDropdownMenu);

      // Ë®≠ÂÆöÊåâÈàïÔºöÈªûÊìäÂæåÈ°ØÁ§∫Ë®≠ÂÆöÈù¢ÊùøÔºàË®≠ÂÆöÈù¢Êùø‰πüÂè™Â±¨Êñº UI ÈÉ®ÂàÜÔºâ
      const settingsBtn = document.createElement("button");
      settingsBtn.textContent = "‚öôÔ∏è";
      settingsBtn.style.width = "35px";
      settingsBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
      settingsBtn.style.color = fixedButtonStyle.color;
      settingsBtn.style.border = fixedButtonStyle.border;
      settingsBtn.style.borderRadius = fixedButtonStyle.borderRadius;
      settingsBtn.style.padding = fixedButtonStyle.padding;
      settingsBtn.style.cursor = fixedButtonStyle.cursor;
      settingsBtn.addEventListener("click", showSettingsPanel);
      exportRow.appendChild(settingsBtn);

      container.innerHTML = "";
      container.appendChild(selectRow);
      container.appendChild(exportRow);

      /*****************************************
       * Ë®≠ÂÆöÈù¢ÊùøÔºöË®≠ÂÆö‰ΩøÁî®ËÄÖÂêçÁ®±„ÄÅËßíËâ≤ÂêçÁ®±„ÄÅÂ§ñËßÄÁ≠âÔºàÂÉÖ UIÔºâ
       *****************************************/
      function showSettingsPanel() {
        const style = document.createElement("style");
        style.textContent = `
          .setting-input, .setting-select {
            height: 36px;
            padding: 4px 8px;
            font-size: 14px;
            line-height: 1.2;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            background-color: #fff;
            color: #000;
            width: 100%;
            margin-bottom: 5px;
          }
          .setting-color {
            height: 36px;
            width: 100%;
            padding: 0;
            border: none;
            background: none;
          }
          .setting-avatar-container img {
          display: inline-block;
          }
        `;
        document.head.appendChild(style);
      
        const settingsPanel = document.createElement("div");
        settingsPanel.style.position = "fixed";
        settingsPanel.style.top = "50%";
        settingsPanel.style.left = "50%";
        settingsPanel.style.transform = "translate(-50%, -50%)";
        settingsPanel.style.backgroundColor = "#222";
        settingsPanel.style.padding = "20px";
        settingsPanel.style.borderRadius = "6px";
        settingsPanel.style.boxShadow = "0 2px 10px rgba(0,0,0,0.7)";
        settingsPanel.style.zIndex = "10000";
        settingsPanel.style.width = "600px";
        settingsPanel.style.maxHeight = "80vh";
        settingsPanel.style.overflowY = "auto";
      
        const title = document.createElement("div");
        title.textContent = "Ë®≠ÂÆö";
        title.style.marginBottom = "10px";
        title.style.fontSize = "16px";
        title.style.fontWeight = "bold";
        title.style.color = "#fff";
        settingsPanel.appendChild(title);
      
        const settingsContainer = document.createElement("div");
        settingsContainer.style.display = "flex";
        settingsContainer.style.flexWrap = "wrap";
        settingsContainer.style.gap = "10px";
      
        const groups = [
            { label: "Âü∫Êú¨Ë®≠ÂÆö", fields: [
              { label: "‰ΩøÁî®ËÄÖÂêçÁ®±", value: storedUserName, key: "storedUserName" },
              { label: "ËßíËâ≤ÂêçÁ®±", value: storedCharacterName, key: "storedCharacterName" }
            ]},
            { label: "È†≠ÂÉèË®≠ÂÆö", fields: [
              { label: "‰ΩøÁî®ËÄÖÈ†≠ÂÉè", value: storedUserAvatar, key: "storedUserAvatar" },
              { label: "ËßíËâ≤È†≠ÂÉè", value: storedAssistantAvatar, key: "storedAssistantAvatar" }
            ]},
            { label: "Â§ñËßÄË®≠ÂÆö", fields: [
              { label: "ÂúñÁâáÂØ¨Â∫¶ (px)", value: storedImageWidth, key: "storedImageWidth" },
              { label: "Â≠óÈ´îÂ§ßÂ∞è (px)", value: storedFontSize, key: "storedFontSize" },
              { label: "Â≠óÈ´îÈ°èËâ≤", value: storedFontColor, key: "storedFontColor" },
              { label: "‰ΩøÁî®ËÄÖË®äÊÅØËÉåÊôØÈ°èËâ≤", value: storedUserMsgBgColor || "#313131", key: "storedUserMsgBgColor" },
            ]},
            { label: "Â§ñËßÄË®≠ÂÆö", fields: [
              { label: "ËÉåÊôØÈ°èËâ≤", value: storedBackgroundColor, key: "storedBackgroundColor" },
              { label: "Â≠óÈ´î", value: storedFontFamily, key: "storedFontFamily" },
              { label: "Êà™ÂúñÈ¢®Ê†º", value: storedScreenshotStyle, key: "storedScreenshotStyle", type: "select", options: [
                { value: "left", label: "ÂÖ®ÈÉ®Â∑¶ÂÅ¥" },
                { value: "bubble", label: "ËÅäÂ§©Ê≥°Ê≥°" }
              ]},
              { label: "GPTË®äÊÅØËÉåÊôØÈ°èËâ≤", value: storedAssistantMsgBgColor || "#202020", key: "storedAssistantMsgBgColor" }
            ]}
          ];
      
        groups.forEach(group => {
            const groupContainer = document.createElement("div");
            groupContainer.style.flex = "1";
            groupContainer.style.minWidth = "200px";
            groupContainer.style.boxSizing = "border-box";
      
            const groupTitle = document.createElement("div");
            groupTitle.textContent = group.label;
            groupTitle.style.color = "#fff";
            groupTitle.style.marginTop = "10px";
            groupTitle.style.fontWeight = "bold";
            groupContainer.appendChild(groupTitle);
      
            group.fields.forEach(field => {
              const fieldLabel = document.createElement("div");
              fieldLabel.textContent = field.label;
              fieldLabel.style.color = "#fff";
              fieldLabel.style.marginTop = "5px";
              fieldLabel.style.fontSize = "14px";
              groupContainer.appendChild(fieldLabel);
              
              if (field.key === "storedUserAvatar" || field.key === "storedAssistantAvatar") {
                const avatarContainer = document.createElement("div");
                avatarContainer.className = "setting-avatar-container";
                avatarContainer.style.display = "flex";
                avatarContainer.style.alignItems = "center";
                avatarContainer.style.gap = "10px";
                avatarContainer.style.marginBottom = "5px";

                const previewImg = document.createElement("img");
                previewImg.style.width = "36px";
                previewImg.style.height = "36px";
                previewImg.style.objectFit = "cover";
                previewImg.style.border = "1px solid #ccc";
                previewImg.style.borderRadius = "4px";
                previewImg.src = field.value || "";

                const browseBtn = document.createElement("button");
                browseBtn.textContent = "ÁÄèË¶ΩÊ™îÊ°à";
                browseBtn.className = "setting-input"; 
                browseBtn.style.height = "36px";
                browseBtn.style.lineHeight = "28px";
                browseBtn.style.width = "calc(50% - 50px)";
                browseBtn.style.display = "inline-block";

                const fileInput = document.createElement("input");
                fileInput.type = "file";
                fileInput.accept = "image/*";
                fileInput.style.display = "none";
                browseBtn.addEventListener("click", () => fileInput.click());

                fileInput.addEventListener("change", (e) => {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(evt) {
                      const dataURL = evt.target.result;
                      previewImg.src = dataURL;
                      const key = field.key === "storedUserAvatar" ? "storedUserAvatar" : "storedAssistantAvatar";
                      if (key === "storedUserAvatar") storedUserAvatar = dataURL;
                      else storedAssistantAvatar = dataURL;
                      await chrome.storage.local.set({ [key]: dataURL });
                    };
                    reader.readAsDataURL(file);
                  }
                });

                avatarContainer.appendChild(browseBtn);
                avatarContainer.appendChild(previewImg);
                groupContainer.appendChild(fileInput);
                groupContainer.appendChild(avatarContainer);

              } else {
              let input;
              if (field.type === "select") {
                input = document.createElement("select");
                field.options.forEach(opt => {
                  const option = document.createElement("option");
                  option.value = opt.value;
                  option.textContent = opt.label;
                  if (opt.value === field.value) option.selected = true;
                  input.appendChild(option);
                });
                input.className = "setting-select";
              } else {
                input = document.createElement("input");
                input.type = ["storedFontColor", "storedBackgroundColor", "storedUserMsgBgColor", "storedAssistantMsgBgColor"].includes(field.key) ? "color" : "text";
                input.value = field.value;
                input.className = input.type === "color" ? "setting-color" : "setting-input";
              }
      
              input.addEventListener("change", async () => {
                const newValue = input.value.trim();
                switch (field.key) {
                  case "storedUserName": storedUserName = newValue || "‰Ω†"; break;
                  case "storedCharacterName": storedCharacterName = newValue || "ChatGPT"; break;
                  case "storedImageWidth": storedImageWidth = Number(newValue) || 800; break;
                  case "storedFontSize": storedFontSize = Number(newValue) || 16; break;
                  case "storedFontColor": storedFontColor = newValue || "#ffffff"; break;
                  case "storedBackgroundColor": storedBackgroundColor = newValue || "#000000"; break;
                  case "storedFontFamily": storedFontFamily = newValue || "Êñ∞Á¥∞ÊòéÈ´î"; break;
                  case "storedScreenshotStyle": storedScreenshotStyle = newValue; break;
                  case "storedUserMsgBgColor": storedUserMsgBgColor = newValue || "#313131"; break;
                  case "storedAssistantMsgBgColor": storedAssistantMsgBgColor = newValue || "#202020"; break;
                }
                await chrome.storage.local.set({ [field.key]: newValue });
              });
      
              groupContainer.appendChild(input);
            }
          });
      
          settingsContainer.appendChild(groupContainer);
        });
      
        settingsPanel.appendChild(settingsContainer);
      
        const btnContainer = document.createElement("div");
        btnContainer.style.marginTop = "10px";
        btnContainer.style.textAlign = "center";
      
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "ÂÑ≤Â≠ò";
        saveBtn.style.backgroundColor = "#4CAF50";
        saveBtn.style.color = "#fff";
        saveBtn.style.border = "none";
        saveBtn.style.borderRadius = "4px";
        saveBtn.style.padding = "6px 12px";
        saveBtn.style.cursor = "pointer";
        saveBtn.addEventListener("click", () => {
          document.body.removeChild(settingsPanel);
        });
      
        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "ÂèñÊ∂à";
        cancelBtn.style.backgroundColor = "#666";
        cancelBtn.style.color = "#fff";
        cancelBtn.style.border = "none";
        cancelBtn.style.borderRadius = "4px";
        cancelBtn.style.padding = "6px 12px";
        cancelBtn.style.cursor = "pointer";
        cancelBtn.style.marginLeft = "10px";
        cancelBtn.addEventListener("click", () => {
          document.body.removeChild(settingsPanel);
        });
      
        btnContainer.appendChild(saveBtn);
        btnContainer.appendChild(cancelBtn);
        settingsPanel.appendChild(btnContainer);
        document.body.appendChild(settingsPanel);
      }  

    //htmlËΩâÊèõÈñãÂßã
      /**
     * Áî® Fetch ÊäìÂèñÂúñÁâá‰∏¶ËΩâÊàê Base64 Data URI
     * @param {string} url - ÂúñÁâáÁöÑ URL
     * @returns {Promise<string>} ÂõûÂÇ≥ Base64 Ë≥áÊñô URI
     */
      async function fetchAsBase64(url) {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = () => reject("ËÆÄÂèñÂúñÁâáÂ§±Êïó");
            reader.readAsDataURL(blob);
          });
        } catch (err) {
          console.error("Fetch Â§±ÊïóÔºö", err);
          throw err;
        }
      }
        /**
       * ÊõøÊèõ container Ë£°ÊâÄÊúâ <img> ÁöÑ src Â±¨ÊÄßÁÇ∫ Base64 Data URIÔºà‰ΩøÁî® fetchÔºâ
       * @param {HTMLElement} container - ÁõÆÊ®ôÂÆπÂô®
       * @returns {Promise<void>}
       */
      async function replaceImagesWithBase64(container) {
        const images = container.querySelectorAll("img");
        await Promise.all([...images].map(async (img) => {
          if (img.src.startsWith("data:")) return;
          try {
            img.crossOrigin = "anonymous";   // ÈÅøÂÖç CORS Ë¢´ÂππÊéâ
            const dataURL = await fetchAsBase64(img.src);
            img.src = dataURL;
            console.log("ÂúñÁâáÂ∑≤ËΩâ Base64Ôºö", dataURL.slice(0, 40) + "...");
            } catch (err) {
        console.error("ËΩâÊèõÂúñÁâáÂ§±ÊïóÔºö", err);
        }
      }))};
      /**
       * Âêå‰∏ÄÂâáË®äÊÅØË£°ÔºåÂ¶ÇÊûúÂá∫ÁèæÁõ∏ÂêåÁöÑÂúñÁâáÔºåÂè™‰øùÁïôÁ¨¨‰∏ÄÂºµÔºåÂÖ∂È§òÁßªÈô§
       * @param {HTMLElement} container - ÁõÆÊ®ôÂÆπÂô®
       */
      function removeDuplicateImages(container) {
        const images = container.querySelectorAll("img");
        const srcSet = new Set();
        images.forEach((img) => {
          if (srcSet.has(img.src)) {
            img.remove();
          } else {
            srcSet.add(img.src);
          }
        });
      }
      
      async function triggerImageConversion(options = {}) {
        const { splitMode = false, maxHeight = 4096, containerElem: passedContainer } = options;
        let containerElem = passedContainer;
        if (!containerElem) {
          const firstSelected = conversationData.find(m => m.selected);
          if (firstSelected) containerElem = firstSelected.element.parentElement;
        }
        if (!containerElem) {
          containerElem = document.querySelector('article[data-testid^="conversation-turn"]')?.parentElement;
        }
        if (!containerElem) {
          console.error("Êâæ‰∏çÂà∞Â∞çË©±ÂÆπÂô® (triggerImageConversion)");
          return;
        }

        // ÂÖàÂ∞áÂúñÁâáËΩâÁÇ∫ Base64 ‰∏¶ÁßªÈô§ÈáçË§áÂúñÁâá
        await replaceImagesWithBase64(containerElem);
        removeDuplicateImages(containerElem);

        // ‰ΩøÁî® Turndown ËΩâ MarkdownÔºå‰∏¶Âä†ÂÖ• GFM ÊîØÊè¥ÔºàËã•Â∑≤ËºâÂÖ• turndown-plugin-gfmÔºâ
        conversationData.forEach(msg => {
          const original = msg.element;
          const cloned = original.cloneNode(true);
        
          // 1. ÁßªÈô§ <h5>/<h6> ÁöÑ sr-only
          cloned.querySelectorAll("h5.sr-only, h6.sr-only").forEach(el => el.remove());
        
          // 2. ÂúñÁâáËôïÁêÜÔºöÊääÂéüÂßãÂúñÁâáÔºàÂ∑≤ËΩâ base64ÔºâÂ°ûÂõû cloned
          const originalImgs = original.querySelectorAll("img");
          const clonedImgs = cloned.querySelectorAll("img");
          clonedImgs.forEach((img, i) => {
            if (originalImgs[i]) img.src = originalImgs[i].src;
          });
        
          // 3. Âè™Âèñ„ÄåÁúüÊ≠£Ë®äÊÅØ„ÄçÁöÑÂÆπÂô®Ôºàclass ÂêçÂ§™Èï∑Êàë‰ªñÂ™Ω‰πüÊúÉËÉåÔºâ
          const contentDiv = cloned.querySelector("div.flex.max-w-full.flex-col.grow");
        
          // ÂÆâÂÖ®Ê™¢Êü•ÔºöÊ≤íÊúâÁöÑË©±Â∞±ÊîæÁ©∫
          msg.html = contentDiv ? contentDiv.innerHTML : "<p>ÔºàÂÖßÂÆπÊ∂àÂ§±ÊÉπ QQÔºâ</p>";
        
          // 4. markdown ËΩâÊèõ
          msg.markdown = getMarkdownFromMessage(contentDiv || cloned, msg.role === "user");

        });
        window.__cocoCatchSplitMode = splitMode;
        window.__cocoCatchMaxHeight = maxHeight;
        // ÂÆöÁæ©Êà™ÂúñË®≠ÂÆöÔºàÂèØÊ†πÊìöÈúÄÊ±ÇË™øÊï¥Ôºâ
        const settings = {
          storedFormat,
            pageTitle: document.title,
            storedImageWidth,
            storedFontSize,
            storedFontColor,
            storedBackgroundColor,
            storedFontFamily,
            storedUserAvatar,
            storedAssistantAvatar,
            storedScreenshotStyle,
            storedUserMsgBgColor,
            storedAssistantMsgBgColor
        };
        }

      /*****************************************
       * ÂåØÂá∫ÂäüËÉΩÔºöÊî∂ÈõÜÂ∞çË©±ÂæåÔºå‰∫§Áµ¶ background Â±§ËôïÁêÜ
       *****************************************/
      async function doExport() {
        await scanConversation();
        let selectedMessages = conversationData.filter(m => m.selected);
        if (selectedMessages.length === 0) {
          alert("Ê≤íÊúâÁ¨¶ÂêàÁØ©ÈÅ∏Ê¢ù‰ª∂ÁöÑË®äÊÅØÔºÅ");
          return;
        }
        const isImageExport = (storedFormat === "image");
        const MAX_HEIGHT = 4096;
        let splitMode = false;
      
        if (isImageExport) {
          // Âè™Ë®àÁÆóÈÅ∏ÂèñÂçÄÊÆµÁöÑÈ´òÂ∫¶
          const totalHeight = selectedMessages.reduce((h, m) => h + (m.element?.offsetHeight || 0), 0);
          if (totalHeight > MAX_HEIGHT) {
            const ok = window.confirm(`ÈÅ∏ÂèñÁöÑË®äÊÅØÈ´òÂ∫¶ ${totalHeight}px Â∑≤Ë∂ÖÈÅé ${MAX_HEIGHT}pxÔºåÂ∞áËá™ÂãïÂàÜÂºµ‰∏¶Â£ìÁ∏Æ‰∏ãËºâÔºåÁ¢∫ÂÆöÂóéÔºü`);
            if (!ok) return;
            splitMode = true;
          }
        }
        await triggerImageConversion({ splitMode, maxHeight: MAX_HEIGHT });
        // Âª∫Á´ã sanitizedDataÔºå‰∏çÂåÖÂê´ element Â±¨ÊÄß
        const sanitizedData = selectedMessages.map(m => {
          return {
            id: m.id,
            role: m.role,
            // ÂåØÂá∫Áî®ÔºöÂâçÈù¢Âä†‰ΩøÁî®ËÄÖËá™Ë®ÇÂêçÁ®±
            text: `${m.role === "user" ? storedUserName : storedCharacterName}Ôºö${m.markdown}`,
            // Êà™ÂúñÁî®Ôºö‰øùÊåÅÁ¥îÂéüÊñáÁµ¶ marked Ëß£Êûê
            markdown: m.markdown,
            selected: m.selected,
            //html: m.html
          };
        });
      
        const payload = {
          conversationData: sanitizedData,
          settings: {
            splitMode,
            maxHeight: MAX_HEIGHT,
            storedFormat,
            storedUserName,
            storedCharacterName,
            storedImageWidth,
            storedFontSize,
            storedFontColor,
            storedBackgroundColor,
            storedFontFamily,
            storedUserAvatar,
            storedAssistantAvatar,
            storedScreenshotStyle,
            storedUserMsgBgColor,
            storedAssistantMsgBgColor,
            fileNameBase: document.title
          }
        };
      
        try {
          // Áõ¥Êé•Âú®content script‰∏≠Âü∑Ë°åÂåØÂá∫ÈÇèËºØ
          const result = await handleExport(sanitizedData, payload.settings);
          console.log("ÂåØÂá∫ÂÆåÊàê:", result);
        } catch (error) {
          console.error("ÂåØÂá∫Â§±Êïó:", error);
        }
      }
      
      // Âπ´Ë®äÊÅØÂä†ÂÖ•ÂãæÈÅ∏Ê°Ü
      function addCheckboxToMessage(article, msgId) {
        if (article.querySelector(`[data-msg-id="${msgId}"]`)) return;
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "chat-export-checkbox";
        chk.setAttribute("data-msg-id", msgId);
        const msg = conversationData.find(m => m.id === msgId);
        chk.checked = !!(msg && msg.selected);
        chk.style.position = "absolute";
        chk.style.right = "100px";
        chk.style.top = "42px";
        chk.style.zIndex = "1000";
        chk.addEventListener("change", () => {
          const changingMsg = conversationData.find(m => m.id === msgId);
          if (changingMsg) changingMsg.selected = chk.checked;
        });
        article.style.position = "relative";
        article.appendChild(chk);
      }

      // <<< REPLACED/NEW >>> ÂÖ®Êñ∞ÁöÑÂïüÂãïÂíåÁõ£ËÅΩÈÇèËºØ

      // 1. MutationObserver ÊåÅÁ∫åÁõ£ËÅΩ DOM ËÆäÂåñ (Êñ∞Ë®äÊÅØ„ÄÅÈáçÊñ∞ÁîüÊàê)
      const mainObserver = new MutationObserver(async (mutations) => {
        // ÂÅµÊ∏¨Âà∞‰ªª‰ΩïÂ≠êÊ®πËÆäÂåñÔºåÈÉΩÈáçÊñ∞ÊéÉÊèè‰∏ÄÊ¨°
        // scanConversation ÂÖßÈÉ®ÁöÑÊ©üÂà∂ÊúÉËôïÁêÜÂ•Ω URL ËÆäÊõ¥ÂíåÊñ∞Ë®äÊÅØ
        const hasRelevantChanges = mutations.some(m => m.type === 'childList' && m.addedNodes.length > 0);
        if (hasRelevantChanges) {
          await scanConversation();
        }
      });

      // 2. ‰ΩøÁî® setInterval Á¢∫‰øùÊì¥ÂÖÖÂäüËÉΩÂú®È†ÅÈù¢ÂàáÊèõÂæåËÉΩÊ≠£Á¢∫ÂïüÂãï
      //    ÈÄôÊØîÂñÆÁ¥îÁöÑ waitForElement Êõ¥ËÉΩÊáâÂ∞ç SPA ÁöÑË§áÈõúËºâÂÖ•
      let startupInterval = setInterval(() => {
        const mainElem = document.querySelector("main");
        const threadElem = document.querySelector('div[class*="react-scroll-to-bottom"]'); // ChatGPT ÂØ¶ÈöõÂ∞çË©±ÊªæÂãïÂçÄ

        // ÂøÖÈ†àÁ≠âÂà∞ <main> ÂíåÂ∞çË©±ÊªæÂãïÂçÄÈÉΩÂá∫ÁèæÔºåÊâç‰ª£Ë°®È†ÅÈù¢ËºâÂÖ•ÂÆåÊàê
        if (mainElem && threadElem) {
          console.log("‚úÖ ChatGPT UI is ready. Initializing exporter.");
          
          // È¶ñÊ¨°Âü∑Ë°å
          currentUrl = window.location.pathname;
          scanConversation();
          
          // ÂïüÂãï MutationObserver
          mainObserver.observe(mainElem, {
            childList: true,
            subtree: true,
          });
          
          // ÂÆåÊàêÂæåÊ∏ÖÈô§ Interval
          clearInterval(startupInterval);
        }
      }, 500);
    
    console.log('‚úÖ ChatGPT ÂåØÂá∫Â∑•ÂÖ∑ÂàùÂßãÂåñÂÆåÊàê');
  }

  // Gemini ÂàùÂßãÂåñÈÇèËºØ
  async function initGemini() {
    console.log('üîÆ ÂàùÂßãÂåñ Gemini ÂåØÂá∫Â∑•ÂÖ∑');
    
    const storedData = await chrome.storage.local.get({
      storedFormat: "text",
      storedUserName: "‰Ω†",
      storedCharacterName: "Gemini",
      storedImageWidth: 800,
      storedFontSize: 16,
      storedFontColor: "#ffffff",
      storedBackgroundColor: "#000000",
      storedFontFamily: "Êñ∞Á¥∞ÊòéÈ´î",
      storedUserAvatar: "",
      storedAssistantAvatar: "",
      storedScreenshotStyle: "left",
      storedUserMsgBgColor: "#313131",
      storedAssistantMsgBgColor: "#202020"
    });
    
    let storedFormat = storedData.storedFormat;
    let storedUserName = storedData.storedUserName;
    let storedCharacterName = storedData.storedCharacterName;
    let storedImageWidth = storedData.storedImageWidth;
    let storedFontSize = storedData.storedFontSize;
    let storedFontColor = storedData.storedFontColor;
    let storedBackgroundColor = storedData.storedBackgroundColor;
    let storedFontFamily = storedData.storedFontFamily;
    let storedUserAvatar = storedData.storedUserAvatar;
    let storedAssistantAvatar = storedData.storedAssistantAvatar;
    let storedScreenshotStyle = storedData.storedScreenshotStyle;
    let storedUserMsgBgColor = storedData.storedUserMsgBgColor;
    let storedAssistantMsgBgColor = storedData.storedAssistantMsgBgColor;

    let selectionModeEnabled = false;
    let conversationData = [];
    let currentUrl = window.location.pathname;

    function generateId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    // Ê™¢Êü•ËÅäÂ§©ÊòØÂê¶ÂàáÊèõ
    function checkIfChatChanged() {
      if (window.location.pathname !== currentUrl) {
        console.log("URL change detected. Resetting conversation data.");
        currentUrl = window.location.pathname;
        conversationData = [];
        
        // ÁßªÈô§ÊâÄÊúâËàäÁöÑÂãæÈÅ∏Ê°Ü
        document.querySelectorAll(".chat-export-checkbox").forEach(cb => cb.remove());
        
        // ÁßªÈô§ËàäÁöÑÊ®ôË®ò
        const allUserQueries = document.querySelectorAll("user-query-content");
        const allMessages = document.querySelectorAll("message-content");
        [...allUserQueries, ...allMessages].forEach(elem => elem.removeAttribute("data-exported"));
      }
    }

    // === Ê†∏ÂøÉ‰øÆÊîπÔºöÈÅ©ÈÖç Gemini ÁöÑ DOM ÁµêÊßã ===
    async function scanConversation() {
      checkIfChatChanged();

      // 1. Áç≤Âèñ Gemini ÁöÑÁî®Êà∂Êü•Ë©¢Âíå AI ÂõûÊáâ
      const userQueries = Array.from(document.querySelectorAll("user-query-content"));
      const aiResponses = Array.from(document.querySelectorAll("message-content"));
      
      // 2. Âêà‰ΩµÊâÄÊúâË®äÊÅØÂÖÉÁ¥†‰∏¶Êåâ DOM È†ÜÂ∫èÊéíÂ∫è
      const allMessageElements = [...userQueries, ...aiResponses];
      allMessageElements.sort((a, b) => {
        const position = a.compareDocumentPosition(b);
        if (position & Node.DOCUMENT_POSITION_FOLLOWING) return -1;
        if (position & Node.DOCUMENT_POSITION_PRECEDING) return 1;
        return 0;
      });

      const currentElementSet = new Set(allMessageElements);

      // 3. Ê∏ÖÁêÜ conversationDataÔºöÁßªÈô§Â∑≤‰∏çÂ≠òÂú®ÁöÑÂÖÉÁ¥†
      conversationData = conversationData.filter(msg => currentElementSet.has(msg.element));

      const existingElementsInConvData = new Set(conversationData.map(msg => msg.element));

      // 4. Êñ∞Â¢ûÊñ∞Ë®äÊÅØ
      for (const element of allMessageElements) {
        if (!existingElementsInConvData.has(element)) {
          const role = element.tagName.toLowerCase() === "user-query-content" ? "user" : "assistant";
          
          // ÊèêÂèñÊñáÂ≠óÂÖßÂÆπ
          let finalText = "";
          if (role === "user") {
            // Áî®Êà∂Ë®äÊÅØÔºöÂæû .query-text-line ÊèêÂèñÔºà‰øùÊåÅÊèõË°åÔºâ
            const queryTextLines = element.querySelectorAll(".query-text-line");
            if (queryTextLines.length > 0) {
              finalText = Array.from(queryTextLines)
                .map(line => line.textContent.trim())
                .filter(line => line.length > 0) // ÈÅéÊøæÁ©∫Ë°å
                .join("\n");
            } else {
              // ÂÇôÁî®ÊñπÊ°àÔºöÂæû .query-text ÊèêÂèñ
              const queryText = element.querySelector(".query-text");
              if (queryText) {
                const paragraphs = queryText.querySelectorAll("p");
                if (paragraphs.length > 0) {
                  finalText = Array.from(paragraphs)
                    .map(p => p.textContent.trim())
                    .filter(text => text.length > 0)
                    .join("\n");
                } else {
                  finalText = queryText.textContent.trim();
                }
              } else {
                finalText = element.textContent.trim();
              }
            }
          } else {
            // AI ÂõûÊáâÔºöÂæû .markdown ÂÆπÂô®ÊèêÂèñ
            const markdownContainer = element.querySelector(".markdown");
            finalText = markdownContainer ? markdownContainer.textContent.trim() : element.textContent.trim();
          }

          const newMessageData = {
            id: generateId(),
            role,
            text: finalText,
            markdown: getMarkdownFromMessage(element, role === "user"),
            element: element,
            selected: true
          };
          conversationData.push(newMessageData);
        }
      }

      // 5. ÈáçÊñ∞ÊéíÂ∫èÔºàÊåâ DOM È†ÜÂ∫èÔºâ
      conversationData.sort((a, b) => {
        const position = a.element.compareDocumentPosition(b.element);
        if (position & Node.DOCUMENT_POSITION_FOLLOWING) return -1;
        if (position & Node.DOCUMENT_POSITION_PRECEDING) return 1;
        return 0;
      });

      // 6. Â¶ÇÊûúËôïÊñºÈÅ∏ÊìáÊ®°ÂºèÔºåÁÇ∫Êñ∞ÊéÉÊèèÂà∞ÁöÑË®äÊÅØÂä†‰∏äÂãæÈÅ∏Ê°Ü
      if (selectionModeEnabled) {
        conversationData.forEach(msg => {
          if (!msg.element.querySelector(".chat-export-checkbox")) {
            addCheckboxToMessage(msg.element, msg.id);
          }
        });
      }
    }

    // ÂÆâÂÖ®ËΩâÁæ©
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, (m) =>
        ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])
      );
    }

    // ÊääË®äÊÅØËΩâÊàê MarkdownÔºàÈÅ©ÈÖç GeminiÔºâ
    function getMarkdownFromMessage(el, isUser) {
      if (!isUser) {
        // AI ÂõûÊáâÔºöÂòóË©¶Âæû markdown ÂÆπÂô®ÂèñÂæó HTML
        const markdownContainer = el.querySelector(".markdown");
        if (markdownContainer) {
          return turndownService.turndown(markdownContainer.innerHTML);
        }
        return turndownService.turndown(el.innerHTML);
      }

        // 1. È¶ñÂÖàÂòóË©¶Âæû .query-text-line ÂÖÉÁ¥†ÊèêÂèñÔºàÊØèÂÄãÂÖÉÁ¥†‰∏ÄË°åÔºâ
        const queryTextLines = el.querySelectorAll(".query-text-line");
        if (queryTextLines.length > 0) {
          return Array.from(queryTextLines)
            .map(line => line.textContent.trim())
            .filter(line => line.length > 0) // ÈÅéÊøæÁ©∫Ë°å
            .join("\n");
        }

        // 2. ÂÇôÁî®ÊñπÊ°àÔºöÂæû .query-text ÊèêÂèñ
        const queryText = el.querySelector(".query-text");
        if (queryText) {
          // Ê™¢Êü•ÊòØÂê¶ÊúâÂ§öÂÄã <p> Ê®ôÁ±§
          const paragraphs = queryText.querySelectorAll("p");
          if (paragraphs.length > 0) {
            return Array.from(paragraphs)
              .map(p => p.textContent.trim())
              .filter(text => text.length > 0)
              .join("\n");
          }
          return queryText.textContent.trim();
        }

        // 3. ÊúÄÂæåÂÇôÁî®ÊñπÊ°àÔºöÁõ¥Êé•ÂæûÂÖÉÁ¥†ÊñáÂ≠óÂÖßÂÆπÊèêÂèñ
        const raw = el.textContent || "";
        return raw
          .split("\n")
          .map(line => line.trimEnd())
          .filter(line => line.length > 0) // ÈÅéÊøæÁ©∫Ë°å
          .join("\n");
      }

    // ÂàùÂßãÂåñ Turndown ÊúçÂãô
    const turndownService = new TurndownService();
    if (typeof turndownPluginGfm !== "undefined" && turndownPluginGfm.gfm) {
      turndownService.use(turndownPluginGfm.gfm);
    }
    
    turndownService.addRule('strikethrough', {
      filter: ['del', 's', 'strike'],
      replacement: function(content) {
        return '~~' + content + '~~';
      }
    });

    turndownService.addRule('geminiCode', {
      filter: function (node) {
        return (
          node.nodeName === 'CODE' &&
          node.textContent.includes('\n')
        );
      },
      replacement: function (content, node) {
        // Gemini ÂèØËÉΩÊ≤íÊúâÊòéÁ¢∫ÁöÑË™ûË®ÄÊ®ôË®òÔºå‰ΩøÁî®ÈÄöÁî®ËôïÁêÜ
        return `\n\n\`\`\`\n${node.textContent}\n\`\`\`\n\n`;
      }
    });

    /*****************************************
     * Ê≥®ÂÖ•ÊéßÂà∂Èù¢ÊùøÂà∞ÊåáÂÆö‰ΩçÁΩÆ (Âè™Ë≤†Ë≤¨ UI)
     *****************************************/
    let container = document.getElementById("gemini-exporter-container");
    if (!container) {
      container = document.createElement("div");
      container.id = "gemini-exporter-container";
      container.style.position = "fixed";
      container.style.right = "100px"; 
      container.style.bottom = "25px"; 
      container.style.zIndex = 9999;
      document.body.appendChild(container);
    }
    container.innerHTML = "";
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.gap = "4px";
    
    // ÂÖ®ÂüüÈÅ∏ÊìáË®≠ÂÆö
    let storedFilter = "all";

    /********************
     * Á¨¨‰∏ÄÊéíÔºöSelect row
     ********************/
    const selectRow = document.createElement("div");
    selectRow.style.display = "flex";
    selectRow.style.alignItems = "center";
    selectRow.style.gap = "4px";

    // „ÄåSelect„ÄçÊåâÈàï
    const fixedButtonStyle = {
      width: "80px",
      backgroundColor: "#444",
      color: "#fff",
      border: "none",
      borderRadius: "4px",
      padding: "4px 8px",
      cursor: "pointer"
    };

    const selectBtn = document.createElement("button");
    selectBtn.textContent = "Select";
    Object.assign(selectBtn.style, fixedButtonStyle);
    selectBtn.addEventListener("click", async () => {
      selectionModeEnabled = !selectionModeEnabled;
    
      if (selectionModeEnabled) {
        await scanConversation();
        conversationData.forEach(msg => {
          addCheckboxToMessage(msg.element, msg.id);
        });
        globalSelectChk.style.display = "inline-block";
        globalSelectChk.style.position = "absolute";
        globalSelectChk.style.right = "8px";
        globalSelectChk.style.top = "5px";
    
        if (storedFilter === "all") {
          conversationData.forEach(m => (m.selected = true));
          document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
            cb.checked = true;
          });
          globalSelectChk.checked = true;
        } else if (storedFilter === "user") {
          conversationData.forEach(m => (m.selected = (m.role === "user")));
          document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
            const msgId = cb.getAttribute("data-msg-id");
            const msg = conversationData.find(m => m.id === msgId);
            cb.checked = msg && msg.role === "user";
          });
          globalSelectChk.checked = false;
        } else if (storedFilter === "assistant") {
          conversationData.forEach(m => (m.selected = (m.role === "assistant")));
          document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
            const msgId = cb.getAttribute("data-msg-id");
            const msg = conversationData.find(m => m.id === msgId);
            cb.checked = msg && msg.role === "assistant";
          });
          globalSelectChk.checked = false;
        }
      } else {
        document.querySelectorAll(".chat-export-checkbox").forEach(cb => cb.remove());
        globalSelectChk.style.display = "none";
      }
    });
    selectRow.appendChild(selectBtn);

    const selectDropdownBtn = document.createElement("button");
    selectDropdownBtn.textContent = "‚ñæ";
    selectDropdownBtn.style.width = "25px";
    selectDropdownBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
    selectDropdownBtn.style.color = fixedButtonStyle.color;
    selectDropdownBtn.style.border = fixedButtonStyle.border;
    selectDropdownBtn.style.borderRadius = fixedButtonStyle.borderRadius;
    selectDropdownBtn.style.padding = "4px 6px";
    selectDropdownBtn.style.cursor = fixedButtonStyle.cursor;
    selectRow.appendChild(selectDropdownBtn);

    // ÂÖ®ÈÅ∏ÂãæÈÅ∏Ê°Ü (ÂÖ®Â±Ä)
    const globalSelectChk = document.createElement("input");
    globalSelectChk.type = "checkbox";
    globalSelectChk.checked = true;
    globalSelectChk.style.display = "none";
    globalSelectChk.addEventListener("change", () => {
      document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
        cb.checked = globalSelectChk.checked;
        const msgId = cb.getAttribute("data-msg-id");
        const msg = conversationData.find(m => m.id === msgId);
        if (msg) msg.selected = globalSelectChk.checked;
      });
    });
    selectRow.appendChild(globalSelectChk);

    // ‰∏ãÊãâÈÅ∏ÂñÆ (Select)
    const selectDropdownMenu = document.createElement("div");
    selectDropdownMenu.style.position = "absolute";
    selectDropdownMenu.style.backgroundColor = "#555";
    selectDropdownMenu.style.border = "1px solid #777";
    selectDropdownMenu.style.borderRadius = "4px";
    selectDropdownMenu.style.padding = "4px";
    selectDropdownMenu.style.bottom = "35px";
    selectDropdownMenu.style.left = "0";
    selectDropdownMenu.style.display = "none";
    
    const selectOptions = [
      { value: "all", label: "ÂÖ®ÈÅ∏" },
      { value: "user", label: "Âè™ÈÅ∏ user" },
      { value: "assistant", label: "Âè™ÈÅ∏ Gemini" }
    ];
    
    selectOptions.forEach(opt => {
      const optBtn = document.createElement("div");
      optBtn.textContent = opt.label;
      optBtn.style.padding = "4px";
      optBtn.style.cursor = "pointer";
      if (opt.value === storedFilter) {
        optBtn.style.backgroundColor = "#777";
      }
      optBtn.addEventListener("click", () => {
        storedFilter = opt.value;
        Array.from(selectDropdownMenu.children).forEach(child => {
          child.style.backgroundColor = (child.textContent === opt.label ? "#777" : "");
        });
        selectDropdownBtn.textContent = "‚ñæ";
        selectDropdownMenu.style.display = "none";
        
        conversationData.forEach(msg => {
          let newState;
          if (storedFilter === "all") {
            newState = true;
          } else if (storedFilter === "user") {
            newState = (msg.role === "user");
          } else if (storedFilter === "assistant") {
            newState = (msg.role === "assistant");
          }
          msg.selected = newState;
          const chk = msg.element.querySelector(`[data-msg-id="${msg.id}"]`);
          if (chk) {
            chk.checked = newState;
          }
        });
        globalSelectChk.checked = (storedFilter === "all");
      });
      selectDropdownMenu.appendChild(optBtn);
    });
    
    selectDropdownBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      selectDropdownMenu.style.display = selectDropdownMenu.style.display === "none" ? "block" : "none";
    });
    document.addEventListener("click", () => { selectDropdownMenu.style.display = "none"; });
    selectRow.style.position = "relative";
    selectRow.appendChild(selectDropdownMenu);

    /********************
     * Á¨¨‰∫åÊéíÔºöExport row
     ********************/
    const exportRow = document.createElement("div");
    exportRow.style.display = "flex";
    exportRow.style.alignItems = "center";
    exportRow.style.gap = "4px";

    const exportBtnText = document.createElement("button");
    exportBtnText.textContent = "Export";
    Object.assign(exportBtnText.style, fixedButtonStyle);
    exportBtnText.addEventListener("click", doExport);
    exportRow.appendChild(exportBtnText);

    const exportDropdownBtn = document.createElement("button");
    exportDropdownBtn.textContent = "‚ñæ";
    exportDropdownBtn.style.width = "25px";
    exportDropdownBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
    exportDropdownBtn.style.color = fixedButtonStyle.color;
    exportDropdownBtn.style.border = fixedButtonStyle.border;
    exportDropdownBtn.style.borderRadius = fixedButtonStyle.borderRadius;
    exportDropdownBtn.style.padding = "4px 6px";
    exportDropdownBtn.style.cursor = fixedButtonStyle.cursor;
    exportRow.appendChild(exportDropdownBtn);

    const exportDropdownMenu = document.createElement("div");
    exportDropdownMenu.style.position = "absolute";
    exportDropdownMenu.style.backgroundColor = "#555";
    exportDropdownMenu.style.border = "1px solid #777";
    exportDropdownMenu.style.borderRadius = "4px";
    exportDropdownMenu.style.padding = "4px";
    exportDropdownMenu.style.bottom = "35px";
    exportDropdownMenu.style.left = "0";
    exportDropdownMenu.style.display = "none";

    const formats = [
      { val: "image", label: "IMAGE" },
      { val: "text", label: "TEXT" },
      { val: "markdown", label: "MARKDOWN" },
      { val: "silly", label: "SILLY" }
    ];
    
    formats.forEach(fmt => {
      const fmtBtn = document.createElement("div");
      fmtBtn.textContent = fmt.label;
      fmtBtn.style.padding = "4px";
      fmtBtn.style.cursor = "pointer";
      if (fmt.val === storedFormat) {
        fmtBtn.style.backgroundColor = "#777";
      }
      fmtBtn.addEventListener("click", async () => {
        storedFormat = fmt.val;
        await chrome.storage.local.set({ storedFormat });
        Array.from(exportDropdownMenu.children).forEach(child => {
          child.style.backgroundColor = (child.textContent === fmt.label ? "#777" : "");
        });
        exportDropdownBtn.textContent = "‚ñæ";
        exportDropdownMenu.style.display = "none";
      });
      exportDropdownMenu.appendChild(fmtBtn);
    });
    
    exportDropdownBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      exportDropdownMenu.style.display = exportDropdownMenu.style.display === "none" ? "block" : "none";
    });
    document.addEventListener("click", () => { exportDropdownMenu.style.display = "none"; });
    exportRow.style.position = "relative";
    exportRow.appendChild(exportDropdownMenu);

    // Ë®≠ÂÆöÊåâÈàï
    const settingsBtn = document.createElement("button");
    settingsBtn.textContent = "‚öôÔ∏è";
    settingsBtn.style.width = "35px";
    settingsBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
    settingsBtn.style.color = fixedButtonStyle.color;
    settingsBtn.style.border = fixedButtonStyle.border;
    settingsBtn.style.borderRadius = fixedButtonStyle.borderRadius;
    settingsBtn.style.padding = fixedButtonStyle.padding;
    settingsBtn.style.cursor = fixedButtonStyle.cursor;
    settingsBtn.addEventListener("click", showSettingsPanel);
    exportRow.appendChild(settingsBtn);

    container.innerHTML = "";
    container.appendChild(selectRow);
    container.appendChild(exportRow);

    // Ë®≠ÂÆöÈù¢Êùø (‰øùÊåÅÂéüÊ®£ÔºåÂè™‰øÆÊîπÈ†êË®≠ËßíËâ≤ÂêçÁ®±)
    function showSettingsPanel() {
      const style = document.createElement("style");
      style.textContent = `
        .setting-input, .setting-select {
          height: 36px;
          padding: 4px 8px;
          font-size: 14px;
          line-height: 1.2;
          border-radius: 4px;
          border: 1px solid #ccc;
          box-sizing: border-box;
          background-color: #fff;
          color: #000;
          width: 100%;
          margin-bottom: 5px;
        }
        .setting-color {
          height: 36px;
          width: 100%;
          padding: 0;
          border: none;
          background: none;
        }
        .setting-avatar-container img {
        display: inline-block;
        }
      `;
      document.head.appendChild(style);
    
      const settingsPanel = document.createElement("div");
      settingsPanel.style.position = "fixed";
      settingsPanel.style.top = "50%";
      settingsPanel.style.left = "50%";
      settingsPanel.style.transform = "translate(-50%, -50%)";
      settingsPanel.style.backgroundColor = "#222";
      settingsPanel.style.padding = "20px";
      settingsPanel.style.borderRadius = "6px";
      settingsPanel.style.boxShadow = "0 2px 10px rgba(0,0,0,0.7)";
      settingsPanel.style.zIndex = "10000";
      settingsPanel.style.width = "600px";
      settingsPanel.style.maxHeight = "80vh";
      settingsPanel.style.overflowY = "auto";
    
      const title = document.createElement("div");
      title.textContent = "Ë®≠ÂÆö";
      title.style.marginBottom = "10px";
      title.style.fontSize = "16px";
      title.style.fontWeight = "bold";
      title.style.color = "#fff";
      settingsPanel.appendChild(title);
    
      const settingsContainer = document.createElement("div");
      settingsContainer.style.display = "flex";
      settingsContainer.style.flexWrap = "wrap";
      settingsContainer.style.gap = "10px";
    
      const groups = [
          { label: "Âü∫Êú¨Ë®≠ÂÆö", fields: [
            { label: "‰ΩøÁî®ËÄÖÂêçÁ®±", value: storedUserName, key: "storedUserName" },
            { label: "ËßíËâ≤ÂêçÁ®±", value: storedCharacterName, key: "storedCharacterName" }
          ]},
          { label: "È†≠ÂÉèË®≠ÂÆö", fields: [
            { label: "‰ΩøÁî®ËÄÖÈ†≠ÂÉè", value: storedUserAvatar, key: "storedUserAvatar" },
            { label: "ËßíËâ≤È†≠ÂÉè", value: storedAssistantAvatar, key: "storedAssistantAvatar" }
          ]},
          { label: "Â§ñËßÄË®≠ÂÆö", fields: [
            { label: "ÂúñÁâáÂØ¨Â∫¶ (px)", value: storedImageWidth, key: "storedImageWidth" },
            { label: "Â≠óÈ´îÂ§ßÂ∞è (px)", value: storedFontSize, key: "storedFontSize" },
            { label: "Â≠óÈ´îÈ°èËâ≤", value: storedFontColor, key: "storedFontColor" },
            { label: "‰ΩøÁî®ËÄÖË®äÊÅØËÉåÊôØÈ°èËâ≤", value: storedUserMsgBgColor || "#313131", key: "storedUserMsgBgColor" },
          ]},
          { label: "Â§ñËßÄË®≠ÂÆö", fields: [
            { label: "ËÉåÊôØÈ°èËâ≤", value: storedBackgroundColor, key: "storedBackgroundColor" },
            { label: "Â≠óÈ´î", value: storedFontFamily, key: "storedFontFamily" },
            { label: "Êà™ÂúñÈ¢®Ê†º", value: storedScreenshotStyle, key: "storedScreenshotStyle", type: "select", options: [
              { value: "left", label: "ÂÖ®ÈÉ®Â∑¶ÂÅ¥" },
              { value: "bubble", label: "ËÅäÂ§©Ê≥°Ê≥°" }
            ]},
            { label: "GeminiË®äÊÅØËÉåÊôØÈ°èËâ≤", value: storedAssistantMsgBgColor || "#202020", key: "storedAssistantMsgBgColor" }
          ]}
        ];
    
      groups.forEach(group => {
          const groupContainer = document.createElement("div");
          groupContainer.style.flex = "1";
          groupContainer.style.minWidth = "200px";
          groupContainer.style.boxSizing = "border-box";
    
          const groupTitle = document.createElement("div");
          groupTitle.textContent = group.label;
          groupTitle.style.color = "#fff";
          groupTitle.style.marginTop = "10px";
          groupTitle.style.fontWeight = "bold";
          groupContainer.appendChild(groupTitle);
    
          group.fields.forEach(field => {
            const fieldLabel = document.createElement("div");
            fieldLabel.textContent = field.label;
            fieldLabel.style.color = "#fff";
            fieldLabel.style.marginTop = "5px";
            fieldLabel.style.fontSize = "14px";
            groupContainer.appendChild(fieldLabel);
            
            if (field.key === "storedUserAvatar" || field.key === "storedAssistantAvatar") {
              const avatarContainer = document.createElement("div");
              avatarContainer.className = "setting-avatar-container";
              avatarContainer.style.display = "flex";
              avatarContainer.style.alignItems = "center";
              avatarContainer.style.gap = "10px";
              avatarContainer.style.marginBottom = "5px";

              const previewImg = document.createElement("img");
              previewImg.style.width = "36px";
              previewImg.style.height = "36px";
              previewImg.style.objectFit = "cover";
              previewImg.style.border = "1px solid #ccc";
              previewImg.style.borderRadius = "4px";
              previewImg.src = field.value || "";

              const browseBtn = document.createElement("button");
              browseBtn.textContent = "ÁÄèË¶ΩÊ™îÊ°à";
              browseBtn.className = "setting-input"; 
              browseBtn.style.height = "36px";
              browseBtn.style.lineHeight = "28px";
              browseBtn.style.width = "calc(50% - 50px)";
              browseBtn.style.display = "inline-block";

              const fileInput = document.createElement("input");
              fileInput.type = "file";
              fileInput.accept = "image/*";
              fileInput.style.display = "none";
              browseBtn.addEventListener("click", () => fileInput.click());

              fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = async function(evt) {
                    const dataURL = evt.target.result;
                    previewImg.src = dataURL;
                    const key = field.key === "storedUserAvatar" ? "storedUserAvatar" : "storedAssistantAvatar";
                    if (key === "storedUserAvatar") storedUserAvatar = dataURL;
                    else storedAssistantAvatar = dataURL;
                    await chrome.storage.local.set({ [key]: dataURL });
                  };
                  reader.readAsDataURL(file);
                }
              });

              avatarContainer.appendChild(browseBtn);
              avatarContainer.appendChild(previewImg);
              groupContainer.appendChild(fileInput);
              groupContainer.appendChild(avatarContainer);

            } else {
            let input;
            if (field.type === "select") {
              input = document.createElement("select");
              field.options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt.value;
                option.textContent = opt.label;
                if (opt.value === field.value) option.selected = true;
                input.appendChild(option);
              });
              input.className = "setting-select";
            } else {
              input = document.createElement("input");
              input.type = ["storedFontColor", "storedBackgroundColor", "storedUserMsgBgColor", "storedAssistantMsgBgColor"].includes(field.key) ? "color" : "text";
              input.value = field.value;
              input.className = input.type === "color" ? "setting-color" : "setting-input";
            }
    
            input.addEventListener("change", async () => {
              const newValue = input.value.trim();
              switch (field.key) {
                case "storedUserName": storedUserName = newValue || "‰Ω†"; break;
                case "storedCharacterName": storedCharacterName = newValue || "Gemini"; break;
                case "storedImageWidth": storedImageWidth = Number(newValue) || 800; break;
                case "storedFontSize": storedFontSize = Number(newValue) || 16; break;
                case "storedFontColor": storedFontColor = newValue || "#ffffff"; break;
                case "storedBackgroundColor": storedBackgroundColor = newValue || "#000000"; break;
                case "storedFontFamily": storedFontFamily = newValue || "Êñ∞Á¥∞ÊòéÈ´î"; break;
                case "storedScreenshotStyle": storedScreenshotStyle = newValue; break;
                case "storedUserMsgBgColor": storedUserMsgBgColor = newValue || "#313131"; break;
                case "storedAssistantMsgBgColor": storedAssistantMsgBgColor = newValue || "#202020"; break;
              }
              await chrome.storage.local.set({ [field.key]: newValue });
            });
    
            groupContainer.appendChild(input);
          }
        });
    
        settingsContainer.appendChild(groupContainer);
      });
    
      settingsPanel.appendChild(settingsContainer);
    
      const btnContainer = document.createElement("div");
      btnContainer.style.marginTop = "10px";
      btnContainer.style.textAlign = "center";
    
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "ÂÑ≤Â≠ò";
      saveBtn.style.backgroundColor = "#4CAF50";
      saveBtn.style.color = "#fff";
      saveBtn.style.border = "none";
      saveBtn.style.borderRadius = "4px";
      saveBtn.style.padding = "6px 12px";
      saveBtn.style.cursor = "pointer";
      saveBtn.addEventListener("click", () => {
        document.body.removeChild(settingsPanel);
      });
    
      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "ÂèñÊ∂à";
      cancelBtn.style.backgroundColor = "#666";
      cancelBtn.style.color = "#fff";
      cancelBtn.style.border = "none";
      cancelBtn.style.borderRadius = "4px";
      cancelBtn.style.padding = "6px 12px";
      cancelBtn.style.cursor = "pointer";
      cancelBtn.style.marginLeft = "10px";
      cancelBtn.addEventListener("click", () => {
        document.body.removeChild(settingsPanel);
      });
    
      btnContainer.appendChild(saveBtn);
      btnContainer.appendChild(cancelBtn);
      settingsPanel.appendChild(btnContainer);
      document.body.appendChild(settingsPanel);
    }  

    // ÂúñÁâáËôïÁêÜÂäüËÉΩ (‰øùÊåÅÂéüÊ®£)
    async function fetchAsBase64(url) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = () => reject("ËÆÄÂèñÂúñÁâáÂ§±Êïó");
          reader.readAsDataURL(blob);
        });
      } catch (err) {
        console.error("Fetch Â§±ÊïóÔºö", err);
        throw err;
      }
    }

    async function replaceImagesWithBase64(container) {
      const images = container.querySelectorAll("img");
      await Promise.all([...images].map(async (img) => {
        if (img.src.startsWith("data:")) return;
        try {
          img.crossOrigin = "anonymous";
          const dataURL = await fetchAsBase64(img.src);
          img.src = dataURL;
          console.log("ÂúñÁâáÂ∑≤ËΩâ Base64Ôºö", dataURL.slice(0, 40) + "...");
          } catch (err) {
      console.error("ËΩâÊèõÂúñÁâáÂ§±ÊïóÔºö", err);
      }
    }))};

    function removeDuplicateImages(container) {
      const images = container.querySelectorAll("img");
      const srcSet = new Set();
      images.forEach((img) => {
        if (srcSet.has(img.src)) {
          img.remove();
        } else {
          srcSet.add(img.src);
        }
      });
    }
    
    async function triggerImageConversion(options = {}) {
      const { splitMode = false, maxHeight = 4096, containerElem: passedContainer } = options;
      let containerElem = passedContainer;
      
      if (!containerElem) {
        const firstSelected = conversationData.find(m => m.selected);
        if (firstSelected) containerElem = firstSelected.element.parentElement;
      }
      if (!containerElem) {
        // === ‰øÆÊîπÔºöÂ∞ãÊâæ Gemini ÁöÑÂ∞çË©±ÂÆπÂô® ===
        containerElem = document.querySelector('user-query-content, message-content')?.parentElement;
      }
      if (!containerElem) {
        console.error("Êâæ‰∏çÂà∞Â∞çË©±ÂÆπÂô® (triggerImageConversion)");
        return;
      }

      await replaceImagesWithBase64(containerElem);
      removeDuplicateImages(containerElem);

      conversationData.forEach(msg => {
        const original = msg.element;
        const cloned = original.cloneNode(true);
      
        // === ‰øÆÊîπÔºöÈÅ©ÈÖç Gemini ÁöÑÁµêÊßã ===
        let contentDiv;
        if (msg.role === "user") {
          // Áî®Êà∂Ë®äÊÅØÔºöÂ∞ãÊâæÊü•Ë©¢ÂÖßÂÆπÂÆπÂô®
          contentDiv = cloned.querySelector(".query-content, .user-query-container");
        } else {
          // AI ÂõûÊáâÔºöÂ∞ãÊâæ markdown ÂÖßÂÆπÂÆπÂô®
          contentDiv = cloned.querySelector(".markdown, .model-response-text");
        }
      
        // ÂúñÁâáËôïÁêÜÔºöÊääÂéüÂßãÂúñÁâáÔºàÂ∑≤ËΩâ base64ÔºâÂ°ûÂõû cloned
        const originalImgs = original.querySelectorAll("img");
        const clonedImgs = cloned.querySelectorAll("img");
        clonedImgs.forEach((img, i) => {
          if (originalImgs[i]) img.src = originalImgs[i].src;
        });
      
        // ÂÆâÂÖ®Ê™¢Êü•ÔºöÊ≤íÊúâÁöÑË©±Â∞±ÊîæÁ©∫
        msg.html = contentDiv ? contentDiv.innerHTML : "<p>ÔºàÂÖßÂÆπÊ∂àÂ§±ÊÉπ QQÔºâ</p>";
      
        // markdown ËΩâÊèõ
        msg.markdown = getMarkdownFromMessage(contentDiv || cloned, msg.role === "user");
      });

      window.__cocoCatchSplitMode = splitMode;
      window.__cocoCatchMaxHeight = maxHeight;
    }

    /*****************************************
     * ÂåØÂá∫ÂäüËÉΩÔºöÊî∂ÈõÜÂ∞çË©±ÂæåÔºå‰∫§Áµ¶ background Â±§ËôïÁêÜ
     *****************************************/
    async function doExport() {
      await scanConversation();
      let selectedMessages = conversationData.filter(m => m.selected);
      if (selectedMessages.length === 0) {
        alert("Ê≤íÊúâÁ¨¶ÂêàÁØ©ÈÅ∏Ê¢ù‰ª∂ÁöÑË®äÊÅØÔºÅ");
        return;
      }
      
      const isImageExport = (storedFormat === "image");
      const MAX_HEIGHT = 4096;
      let splitMode = false;
    
      if (isImageExport) {
        const totalHeight = selectedMessages.reduce((h, m) => h + (m.element?.offsetHeight || 0), 0);
        if (totalHeight > MAX_HEIGHT) {
          const ok = window.confirm(`ÈÅ∏ÂèñÁöÑË®äÊÅØÈ´òÂ∫¶ ${totalHeight}px Â∑≤Ë∂ÖÈÅé ${MAX_HEIGHT}pxÔºåÂ∞áËá™ÂãïÂàÜÂºµ‰∏¶Â£ìÁ∏Æ‰∏ãËºâÔºåÁ¢∫ÂÆöÂóéÔºü`);
          if (!ok) return;
          splitMode = true;
        }
      }
      
      await triggerImageConversion({ splitMode, maxHeight: MAX_HEIGHT });
      
      const sanitizedData = selectedMessages.map(m => {
        return {
          id: m.id,
          role: m.role,
          text: `${m.role === "user" ? storedUserName : storedCharacterName}Ôºö${m.markdown}`,
          markdown: m.markdown,
          selected: m.selected,
        };
      });
    
      const payload = {
        conversationData: sanitizedData,
        settings: {
          splitMode,
          maxHeight: MAX_HEIGHT,
          storedFormat,
          storedUserName,
          storedCharacterName,
          storedImageWidth,
          storedFontSize,
          storedFontColor,
          storedBackgroundColor,
          storedFontFamily,
          storedUserAvatar,
          storedAssistantAvatar,
          storedScreenshotStyle,
          storedUserMsgBgColor,
          storedAssistantMsgBgColor,
          fileNameBase: document.title
        }
      };
    
      try {
          // Áõ¥Êé•Âú®content script‰∏≠Âü∑Ë°åÂåØÂá∫ÈÇèËºØ
          const result = await handleExport(sanitizedData, payload.settings);
          console.log("ÂåØÂá∫ÂÆåÊàê:", result);
          
        } catch (error) {
          console.error("ÂåØÂá∫Â§±Êïó:", error);
        }
      }
    
    // Âπ´Ë®äÊÅØÂä†ÂÖ•ÂãæÈÅ∏Ê°Ü
    function addCheckboxToMessage(element, msgId) {
      if (element.querySelector(`[data-msg-id="${msgId}"]`)) return;
      
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.className = "chat-export-checkbox";
      chk.setAttribute("data-msg-id", msgId);
      const msg = conversationData.find(m => m.id === msgId);
      chk.checked = !!(msg && msg.selected);
      chk.style.position = "absolute";
      chk.style.right = "-100px";
      chk.style.top = "10px";
      chk.style.zIndex = "1000";
      chk.addEventListener("change", () => {
        const changingMsg = conversationData.find(m => m.id === msgId);
        if (changingMsg) changingMsg.selected = chk.checked;
      });
      
      element.style.position = "relative";
      element.appendChild(chk);
    }

    // === ‰øÆÊîπÔºöÂÖ®Êñ∞ÁöÑÂïüÂãïÂíåÁõ£ËÅΩÈÇèËºØÔºåÈÅ©ÈÖç Gemini ===

    // 1. MutationObserver ÊåÅÁ∫åÁõ£ËÅΩ DOM ËÆäÂåñ
    const mainObserver = new MutationObserver(async (mutations) => {
      const hasRelevantChanges = mutations.some(m => m.type === 'childList' && m.addedNodes.length > 0);
      if (hasRelevantChanges) {
        await scanConversation();
      }
    });

    // 2. Á≠âÂæÖ Gemini UI ËºâÂÖ•ÂÆåÊàê
    let startupInterval = setInterval(() => {
      // === ‰øÆÊîπÔºöÂ∞ãÊâæ Gemini ÁâπÊúâÁöÑÂÖÉÁ¥† ===
      const mainElem = document.querySelector("main, [role='main']");
      const geminiContainer = document.querySelector("user-query-content, message-content"); // Gemini Â∞çË©±ÂÖÉÁ¥†

      if (mainElem && geminiContainer) {
        console.log("‚úÖ Gemini UI is ready. Initializing exporter.");
        
        // È¶ñÊ¨°Âü∑Ë°å
        currentUrl = window.location.pathname;
        scanConversation();
        
        // ÂïüÂãï MutationObserver
        mainObserver.observe(mainElem, {
          childList: true,
          subtree: true,
        });
        
        // ÂÆåÊàêÂæåÊ∏ÖÈô§ Interval
        clearInterval(startupInterval);
      }
    }, 500);
    
    console.log('‚úÖ Gemini ÂåØÂá∫Â∑•ÂÖ∑ÂàùÂßãÂåñÂÆåÊàê');
  }

  async function initMistralChat() {
    console.log('ü§ñ ÂàùÂßãÂåñ Mistral ÂåØÂá∫Â∑•ÂÖ∑');
    
    const storedData = await chrome.storage.local.get({
        storedFormat: "text",
        storedUserName: "‰Ω†",
        storedCharacterName: "Mistral",
        storedImageWidth: 800,
        storedFontSize: 16,
        storedFontColor: "#ffffff",
        storedBackgroundColor: "#000000",
        storedFontFamily: "Êñ∞Á¥∞ÊòéÈ´î",
        storedUserAvatar: "",
        storedAssistantAvatar: "",
        storedScreenshotStyle: "left",
        storedUserMsgBgColor: "#313131",
        storedAssistantMsgBgColor: "#202020"
      });
      let storedFormat = storedData.storedFormat;
      let storedUserName = storedData.storedUserName;
      let storedCharacterName = storedData.storedCharacterName;
      let storedImageWidth = storedData.storedImageWidth;
      let storedFontSize = storedData.storedFontSize;
      let storedFontColor = storedData.storedFontColor;
      let storedBackgroundColor = storedData.storedBackgroundColor;
      let storedFontFamily = storedData.storedFontFamily;
      let storedUserAvatar = storedData.storedUserAvatar;
      let storedAssistantAvatar = storedData.storedAssistantAvatar;
      let storedScreenshotStyle = storedData.storedScreenshotStyle;
      let storedUserMsgBgColor = storedData.storedUserMsgBgColor;
      let storedAssistantMsgBgColor = storedData.storedAssistantMsgBgColor;

      let selectionModeEnabled = false;
      let conversationData = [];
      let currentUrl = window.location.pathname;

      function generateId() {
        return '_' + Math.random().toString(36).substr(2, 9);
      }

      // Ê™¢Êü• URL ËÆäÂåñ‰∏¶ÈáçÁΩÆÁãÄÊÖã
      function checkIfChatChanged() {
        if (window.location.pathname !== currentUrl) {
          console.log("URL change detected. Resetting conversation data.");
          currentUrl = window.location.pathname;
          conversationData = [];
          
          // ÁßªÈô§ÊâÄÊúâËàäÁöÑÂãæÈÅ∏Ê°Ü
          document.querySelectorAll(".chat-export-checkbox").forEach(cb => cb.remove());
          
          // ÁßªÈô§ËàäÁöÑÊ®ôË®ò
          const allMessages = document.querySelectorAll("[data-mistral-message]");
          allMessages.forEach(msg => msg.removeAttribute("data-exported"));
        }
      }

      // ÊéÉÊèè Mistral Â∞çË©±ÂÖßÂÆπ
      async function scanConversation() {
        checkIfChatChanged(); 

        // 1. ÂàÜÂà•Â∞ãÊâæÁî®Êà∂Ë®äÊÅØÂíå AI Ë®äÊÅØ
        // Áî®Êà∂Ë®äÊÅØÔºö‰ΩøÁî® data-message-author-role="user" Â±¨ÊÄß
        const userMessageContainers = document.querySelectorAll('div[data-message-author-role="user"]');
        // AI Ë®äÊÅØÔºö‰ΩøÁî® data-message-part-type="answer" Â±¨ÊÄß
        const aiMessages = document.querySelectorAll('div[data-message-part-type="answer"]');
        
        // ÂæûÁî®Êà∂Ë®äÊÅØÂÆπÂô®‰∏≠ÊâæÂà∞ÂØ¶ÈöõÁöÑË®äÊÅØÂÖßÂÆπÂÖÉÁ¥†Ôºà.select-textÔºâ
        const userMessages = [];
        userMessageContainers.forEach(container => {
          const selectTextEl = container.querySelector('.select-text');
          if (selectTextEl) {
            userMessages.push(selectTextEl);
          }
        });
        
        // Âêà‰ΩµÊâÄÊúâË®äÊÅØ
        const allMessages = [...userMessages, ...aiMessages];
        const currentMessageSet = new Set(allMessages);

        // 2. Ê∏ÖÁêÜ‰∏çÂ≠òÂú®ÁöÑÂÖÉÁ¥†
        conversationData = conversationData.filter(msg => currentMessageSet.has(msg.element));

        const existingElementsInConvData = new Set(conversationData.map(msg => msg.element));

        // 3. ËôïÁêÜÊñ∞Ë®äÊÅØ
        for (const messageEl of allMessages) {
          if (!existingElementsInConvData.has(messageEl)) {
            // Âà§Êñ∑ÊòØ‰ΩøÁî®ËÄÖÈÇÑÊòØÂä©ÁêÜË®äÊÅØ
            let role;
            if (userMessages.includes(messageEl)) {
              role = "user";
            } else {
              role = "assistant";
            }

            const cloned = messageEl.cloneNode(true);
            
            // ÁßªÈô§‰∏çÈúÄË¶ÅÁöÑÂÖÉÁ¥†
            cloned.querySelectorAll("button, .copy, .lucide").forEach(el => el.remove());
            
            const finalText = cloned.innerText.trim();

            const newMessageData = {
              id: generateId(),
              role,
              text: finalText,
              markdown: getMarkdownFromMessage(cloned, role === "user"),
              element: messageEl,
              selected: true
            };
            
            // ÁÇ∫ÂÖÉÁ¥†Ê∑ªÂä†Ê®ôË®ò‰ª•‰æøË≠òÂà•
            messageEl.setAttribute('data-mistral-message', newMessageData.id);
            
            conversationData.push(newMessageData);
          }
        }

        // ÊåâÁÖß DOM È†ÜÂ∫èÊéíÂ∫è
        conversationData.sort((a, b) => {
            const position = a.element.compareDocumentPosition(b.element);
            if (position & Node.DOCUMENT_POSITION_FOLLOWING) return -1;
            if (position & Node.DOCUMENT_POSITION_PRECEDING) return 1;
            return 0;
        });

        // Â¶ÇÊûúËôïÊñºÈÅ∏ÊìáÊ®°ÂºèÔºåÁÇ∫Êñ∞Ë®äÊÅØÂä†‰∏äÂãæÈÅ∏Ê°Ü
        if (selectionModeEnabled) {
          conversationData.forEach(msg => {
            if (!msg.element.querySelector(".chat-export-checkbox")) {
              addCheckboxToMessage(msg.element, msg.id);
            }
          });
        }
      }

      /***************** Â∑•ÂÖ∑ÔºöÂÆâÂÖ®ËΩâÁæ© *****************/
      function escapeHTML(str) {
        return str.replace(/[&<>"']/g, (m) =>
          ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])
        );
      }

      /***************** ÊääË®äÊÅØËΩâÊàê Markdown *****************/
      function getMarkdownFromMessage(el, isUser) {
        // ‰ΩøÁî®ËÄÖË®äÊÅØ ‚Üí ËôïÁêÜ HTML ÁµêÊßãÔºå‰øùÁïôÊèõË°å
        if (isUser) {
          // ÂÖàÂ∞á <br> Ê®ôÁ±§ËΩâÊèõÁÇ∫ÊèõË°åÁ¨¶
          const htmlContent = el.innerHTML
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<\/span>\s*<span[^>]*>/gi, '\n'); // ËôïÁêÜ span ÈñìÁöÑÊèõË°å
          
          // ÂâµÂª∫Ëá®ÊôÇÂÖÉÁ¥†‰æÜÊèêÂèñÁ¥îÊñáÂ≠ó
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = htmlContent;
          const rawText = tempDiv.textContent || tempDiv.innerText || "";
          
          return rawText
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0) // ÁßªÈô§Á©∫Ë°å
            .join('  \n'); // Markdown ÁöÑÊèõË°åÊ†ºÂºè
        }

        // Mistral Âä©ÁêÜË®äÊÅØ ‚Üí ‰ΩøÁî® Turndown ËΩâÊèõ
        return turndownService.turndown(el.innerHTML);
      }

      const turndownService = new TurndownService();
      if (typeof turndownPluginGfm !== "undefined" && turndownPluginGfm.gfm) {
        turndownService.use(turndownPluginGfm.gfm);
      }
      
      turndownService.addRule('strikethrough', {
        filter: ['del', 's', 'strike'],
        replacement: function(content) {
          return '~~' + content + '~~';
        }
      });
      
      // ÈáùÂ∞ç Mistral ÁöÑÁ®ãÂºèÁ¢ºÂçÄÂ°äËôïÁêÜ
      turndownService.addRule('mistralMultilineCode', {
        filter: function (node) {
          return (
            node.nodeName === 'CODE' &&
            (node.className.includes('language-') || node.textContent.includes('\n'))
          );
        },
        replacement: function (content, node) {
          const langClass = [...node.classList].find(c => c.startsWith('language-'));
          const lang = langClass ? langClass.replace('language-', '') : '';
          return `\n\n\`\`\`${lang}\n${node.textContent}\n\`\`\`\n\n`;
        }
      });

      /*****************************************
       * Ê≥®ÂÖ•ÊéßÂà∂Èù¢ÊùøÂà∞ÊåáÂÆö‰ΩçÁΩÆ
       *****************************************/
      let container = document.getElementById("mistral-exporter-container");
      if (!container) {
        container = document.createElement("div");
        container.id = "mistral-exporter-container";
        container.style.position = "fixed";
        container.style.right = "100px"; 
        container.style.bottom = "25px"; 
        container.style.zIndex = 9999;
        document.body.appendChild(container);
      }
      container.innerHTML = "";
      container.style.display = "flex";
      container.style.flexDirection = "column";
      container.style.gap = "4px";
      
      // ÂÖ®ÂüüÈÅ∏ÊìáË®≠ÂÆö
      let storedFilter = "all";

      /********************
       * Á¨¨‰∏ÄÊéíÔºöSelect row
       ********************/
      const selectRow = document.createElement("div");
      selectRow.style.display = "flex";
      selectRow.style.alignItems = "center";
      selectRow.style.gap = "4px";

      const fixedButtonStyle = {
        width: "80px",
        backgroundColor: "#444",
        color: "#fff",
        border: "none",
        borderRadius: "4px",
        padding: "4px 8px",
        cursor: "pointer"
      };

      const selectBtn = document.createElement("button");
        selectBtn.textContent = "Select";
        Object.assign(selectBtn.style, fixedButtonStyle);
        selectBtn.addEventListener("click", async () => {
          selectionModeEnabled = !selectionModeEnabled;
        
          if (selectionModeEnabled) {
            await scanConversation();
            conversationData.forEach(msg => {
              addCheckboxToMessage(msg.element, msg.id);
            });
            globalSelectChk.style.display = "inline-block";
            globalSelectChk.style.position = "absolute";
            globalSelectChk.style.right = "8px";
            globalSelectChk.style.top = "5px";
        
            if (storedFilter === "all") {
              conversationData.forEach(m => (m.selected = true));
              document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
                cb.checked = true;
              });
              globalSelectChk.checked = true;
            } else if (storedFilter === "user") {
              conversationData.forEach(m => (m.selected = (m.role === "user")));
              document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
                const msgId = cb.getAttribute("data-msg-id");
                const msg = conversationData.find(m => m.id === msgId);
                cb.checked = msg && msg.role === "user";
              });
              globalSelectChk.checked = false;
            } else if (storedFilter === "assistant") {
              conversationData.forEach(m => (m.selected = (m.role === "assistant")));
              document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
                const msgId = cb.getAttribute("data-msg-id");
                const msg = conversationData.find(m => m.id === msgId);
                cb.checked = msg && msg.role === "assistant";
              });
              globalSelectChk.checked = false;
            }
          } else {
            document.querySelectorAll(".chat-export-checkbox").forEach(cb => cb.remove());
            globalSelectChk.style.display = "none";
          }
        });
      selectRow.appendChild(selectBtn);

      const selectDropdownBtn = document.createElement("button");
      selectDropdownBtn.textContent = "‚ñæ";
      selectDropdownBtn.style.width = "25px";
      selectDropdownBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
      selectDropdownBtn.style.color = fixedButtonStyle.color;
      selectDropdownBtn.style.border = fixedButtonStyle.border;
      selectDropdownBtn.style.borderRadius = fixedButtonStyle.borderRadius;
      selectDropdownBtn.style.padding = "4px 6px";
      selectDropdownBtn.style.cursor = fixedButtonStyle.cursor;
      selectRow.appendChild(selectDropdownBtn);
      
      // ÂÖ®ÈÅ∏ÂãæÈÅ∏Ê°Ü
      const globalSelectChk = document.createElement("input");
      globalSelectChk.type = "checkbox";
      globalSelectChk.checked = true;
      globalSelectChk.style.display = "none";
      globalSelectChk.addEventListener("change", () => {
        document.querySelectorAll(".chat-export-checkbox").forEach(cb => {
          cb.checked = globalSelectChk.checked;
          const msgId = cb.getAttribute("data-msg-id");
          const msg = conversationData.find(m => m.id === msgId);
          if (msg) msg.selected = globalSelectChk.checked;
        });
      });
      selectRow.appendChild(globalSelectChk);
      
      // ‰∏ãÊãâÈÅ∏ÂñÆ
      const selectDropdownMenu = document.createElement("div");
      selectDropdownMenu.style.position = "absolute";
      selectDropdownMenu.style.backgroundColor = "#555";
      selectDropdownMenu.style.border = "1px solid #777";
      selectDropdownMenu.style.borderRadius = "4px";
      selectDropdownMenu.style.padding = "4px";
      selectDropdownMenu.style.bottom = "35px";
      selectDropdownMenu.style.left = "0";
      selectDropdownMenu.style.display = "none";
      
      const selectOptions = [
        { value: "all", label: "ÂÖ®ÈÅ∏" },
        { value: "user", label: "Âè™ÈÅ∏ user" },
        { value: "assistant", label: "Âè™ÈÅ∏ Mistral" }
      ];
      
      selectOptions.forEach(opt => {
        const optBtn = document.createElement("div");
        optBtn.textContent = opt.label;
        optBtn.style.padding = "4px";
        optBtn.style.cursor = "pointer";
        if (opt.value === storedFilter) {
          optBtn.style.backgroundColor = "#777";
        }
        optBtn.addEventListener("click", () => {
          storedFilter = opt.value;
          Array.from(selectDropdownMenu.children).forEach(child => {
            child.style.backgroundColor = (child.textContent === opt.label ? "#777" : "");
          });
          selectDropdownBtn.textContent = "‚ñæ";
          selectDropdownMenu.style.display = "none";
          
          conversationData.forEach(msg => {
            let newState;
            if (storedFilter === "all") {
              newState = true;
            } else if (storedFilter === "user") {
              newState = (msg.role === "user");
            } else if (storedFilter === "assistant") {
              newState = (msg.role === "assistant");
            }
            msg.selected = newState;
            const chk = msg.element.querySelector(`[data-msg-id="${msg.id}"]`);
            if (chk) {
              chk.checked = newState;
            }
          });
          globalSelectChk.checked = (storedFilter === "all");
        });
        selectDropdownMenu.appendChild(optBtn);
      });
      
      selectDropdownBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        selectDropdownMenu.style.display = selectDropdownMenu.style.display === "none" ? "block" : "none";
      });
      document.addEventListener("click", () => { selectDropdownMenu.style.display = "none"; });
      selectRow.style.position = "relative";
      selectRow.appendChild(selectDropdownMenu);

      /********************
       * Á¨¨‰∫åÊéíÔºöExport row
       ********************/
      const exportRow = document.createElement("div");
      exportRow.style.display = "flex";
      exportRow.style.alignItems = "center";
      exportRow.style.gap = "4px";

      const exportBtnText = document.createElement("button");
      exportBtnText.textContent = "Export";
      Object.assign(exportBtnText.style, fixedButtonStyle);
      exportBtnText.addEventListener("click", doExport);
      exportRow.appendChild(exportBtnText);

      const exportDropdownBtn = document.createElement("button");
      exportDropdownBtn.textContent = "‚ñæ";
      exportDropdownBtn.style.width = "25px";
      exportDropdownBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
      exportDropdownBtn.style.color = fixedButtonStyle.color;
      exportDropdownBtn.style.border = fixedButtonStyle.border;
      exportDropdownBtn.style.borderRadius = fixedButtonStyle.borderRadius;
      exportDropdownBtn.style.padding = "4px 6px";
      exportDropdownBtn.style.cursor = fixedButtonStyle.cursor;
      exportRow.appendChild(exportDropdownBtn);

      const exportDropdownMenu = document.createElement("div");
      exportDropdownMenu.style.position = "absolute";
      exportDropdownMenu.style.backgroundColor = "#555";
      exportDropdownMenu.style.border = "1px solid #777";
      exportDropdownMenu.style.borderRadius = "4px";
      exportDropdownMenu.style.padding = "4px";
      exportDropdownMenu.style.bottom = "35px";
      exportDropdownMenu.style.left = "0";
      exportDropdownMenu.style.display = "none";

      const formats = [
        { val: "image", label: "IMAGE" },
        { val: "text", label: "TEXT" },
        { val: "markdown", label: "MARKDOWN" },
        { val: "silly", label: "SILLY" }
      ];
      
      formats.forEach(fmt => {
        const fmtBtn = document.createElement("div");
        fmtBtn.textContent = fmt.label;
        fmtBtn.style.padding = "4px";
        fmtBtn.style.cursor = "pointer";
        if (fmt.val === storedFormat) {
          fmtBtn.style.backgroundColor = "#777";
        }
        fmtBtn.addEventListener("click", async () => {
          storedFormat = fmt.val;
          await chrome.storage.local.set({ storedFormat });
          Array.from(exportDropdownMenu.children).forEach(child => {
            child.style.backgroundColor = (child.textContent === fmt.label ? "#777" : "");
          });
          exportDropdownBtn.textContent = "‚ñæ";
          exportDropdownMenu.style.display = "none";
        });
        exportDropdownMenu.appendChild(fmtBtn);
      });
      
      exportDropdownBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        exportDropdownMenu.style.display = exportDropdownMenu.style.display === "none" ? "block" : "none";
      });
      document.addEventListener("click", () => { exportDropdownMenu.style.display = "none"; });
      exportRow.style.position = "relative";
      exportRow.appendChild(exportDropdownMenu);

      // Ë®≠ÂÆöÊåâÈàï
      const settingsBtn = document.createElement("button");
      settingsBtn.textContent = "‚öôÔ∏è";
      settingsBtn.style.width = "35px";
      settingsBtn.style.backgroundColor = fixedButtonStyle.backgroundColor;
      settingsBtn.style.color = fixedButtonStyle.color;
      settingsBtn.style.border = fixedButtonStyle.border;
      settingsBtn.style.borderRadius = fixedButtonStyle.borderRadius;
      settingsBtn.style.padding = fixedButtonStyle.padding;
      settingsBtn.style.cursor = fixedButtonStyle.cursor;
      settingsBtn.addEventListener("click", showSettingsPanel);
      exportRow.appendChild(settingsBtn);

      container.appendChild(selectRow);
      container.appendChild(exportRow);

      /*****************************************
       * Ë®≠ÂÆöÈù¢Êùø
       *****************************************/
      function showSettingsPanel() {
        const style = document.createElement("style");
        style.textContent = `
          .setting-input, .setting-select {
            height: 36px;
            padding: 4px 8px;
            font-size: 14px;
            line-height: 1.2;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            background-color: #fff;
            color: #000;
            width: 100%;
            margin-bottom: 5px;
          }
          .setting-color {
            height: 36px;
            width: 100%;
            padding: 0;
            border: none;
            background: none;
          }
          .setting-avatar-container img {
            display: inline-block;
          }
        `;
        document.head.appendChild(style);
      
        const settingsPanel = document.createElement("div");
        settingsPanel.style.position = "fixed";
        settingsPanel.style.top = "50%";
        settingsPanel.style.left = "50%";
        settingsPanel.style.transform = "translate(-50%, -50%)";
        settingsPanel.style.backgroundColor = "#222";
        settingsPanel.style.padding = "20px";
        settingsPanel.style.borderRadius = "6px";
        settingsPanel.style.boxShadow = "0 2px 10px rgba(0,0,0,0.7)";
        settingsPanel.style.zIndex = "10000";
        settingsPanel.style.width = "600px";
        settingsPanel.style.maxHeight = "80vh";
        settingsPanel.style.overflowY = "auto";
      
        const title = document.createElement("div");
        title.textContent = "Ë®≠ÂÆö";
        title.style.marginBottom = "10px";
        title.style.fontSize = "16px";
        title.style.fontWeight = "bold";
        title.style.color = "#fff";
        settingsPanel.appendChild(title);
      
        const settingsContainer = document.createElement("div");
        settingsContainer.style.display = "flex";
        settingsContainer.style.flexWrap = "wrap";
        settingsContainer.style.gap = "10px";
      
        const groups = [
            { label: "Âü∫Êú¨Ë®≠ÂÆö", fields: [
              { label: "‰ΩøÁî®ËÄÖÂêçÁ®±", value: storedUserName, key: "storedUserName" },
              { label: "ËßíËâ≤ÂêçÁ®±", value: storedCharacterName, key: "storedCharacterName" }
            ]},
            { label: "È†≠ÂÉèË®≠ÂÆö", fields: [
              { label: "‰ΩøÁî®ËÄÖÈ†≠ÂÉè", value: storedUserAvatar, key: "storedUserAvatar" },
              { label: "ËßíËâ≤È†≠ÂÉè", value: storedAssistantAvatar, key: "storedAssistantAvatar" }
            ]},
            { label: "Â§ñËßÄË®≠ÂÆö", fields: [
              { label: "ÂúñÁâáÂØ¨Â∫¶ (px)", value: storedImageWidth, key: "storedImageWidth" },
              { label: "Â≠óÈ´îÂ§ßÂ∞è (px)", value: storedFontSize, key: "storedFontSize" },
              { label: "Â≠óÈ´îÈ°èËâ≤", value: storedFontColor, key: "storedFontColor" },
              { label: "‰ΩøÁî®ËÄÖË®äÊÅØËÉåÊôØÈ°èËâ≤", value: storedUserMsgBgColor || "#313131", key: "storedUserMsgBgColor" },
            ]},
            { label: "Â§ñËßÄË®≠ÂÆö", fields: [
              { label: "ËÉåÊôØÈ°èËâ≤", value: storedBackgroundColor, key: "storedBackgroundColor" },
              { label: "Â≠óÈ´î", value: storedFontFamily, key: "storedFontFamily" },
              { label: "Êà™ÂúñÈ¢®Ê†º", value: storedScreenshotStyle, key: "storedScreenshotStyle", type: "select", options: [
                { value: "left", label: "ÂÖ®ÈÉ®Â∑¶ÂÅ¥" },
                { value: "bubble", label: "ËÅäÂ§©Ê≥°Ê≥°" }
              ]},
              { label: "MistralË®äÊÅØËÉåÊôØÈ°èËâ≤", value: storedAssistantMsgBgColor || "#202020", key: "storedAssistantMsgBgColor" }
            ]}
          ];

        groups.forEach(group => {
            const groupContainer = document.createElement("div");
            groupContainer.style.flex = "1";
            groupContainer.style.minWidth = "200px";
            groupContainer.style.boxSizing = "border-box";
      
            const groupTitle = document.createElement("div");
            groupTitle.textContent = group.label;
            groupTitle.style.color = "#fff";
            groupTitle.style.marginTop = "10px";
            groupTitle.style.fontWeight = "bold";
            groupContainer.appendChild(groupTitle);
      
            group.fields.forEach(field => {
              const fieldLabel = document.createElement("div");
              fieldLabel.textContent = field.label;
              fieldLabel.style.color = "#fff";
              fieldLabel.style.marginTop = "5px";
              fieldLabel.style.fontSize = "14px";
              groupContainer.appendChild(fieldLabel);
              
              if (field.key === "storedUserAvatar" || field.key === "storedAssistantAvatar") {
                const avatarContainer = document.createElement("div");
                avatarContainer.className = "setting-avatar-container";
                avatarContainer.style.display = "flex";
                avatarContainer.style.alignItems = "center";
                avatarContainer.style.gap = "10px";
                avatarContainer.style.marginBottom = "5px";

                const previewImg = document.createElement("img");
                previewImg.style.width = "36px";
                previewImg.style.height = "36px";
                previewImg.style.objectFit = "cover";
                previewImg.style.border = "1px solid #ccc";
                previewImg.style.borderRadius = "4px";
                previewImg.src = field.value || "";

                const browseBtn = document.createElement("button");
                browseBtn.textContent = "ÁÄèË¶ΩÊ™îÊ°à";
                browseBtn.className = "setting-input"; 
                browseBtn.style.height = "36px";
                browseBtn.style.lineHeight = "28px";
                browseBtn.style.width = "calc(50% - 50px)";
                browseBtn.style.display = "inline-block";

                const fileInput = document.createElement("input");
                fileInput.type = "file";
                fileInput.accept = "image/*";
                fileInput.style.display = "none";
                browseBtn.addEventListener("click", () => fileInput.click());

                fileInput.addEventListener("change", (e) => {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(evt) {
                      const dataURL = evt.target.result;
                      previewImg.src = dataURL;
                      const key = field.key === "storedUserAvatar" ? "storedUserAvatar" : "storedAssistantAvatar";
                      if (key === "storedUserAvatar") storedUserAvatar = dataURL;
                      else storedAssistantAvatar = dataURL;
                      await chrome.storage.local.set({ [key]: dataURL });
                    };
                    reader.readAsDataURL(file);
                  }
                });

                avatarContainer.appendChild(browseBtn);
                avatarContainer.appendChild(previewImg);
                groupContainer.appendChild(fileInput);
                groupContainer.appendChild(avatarContainer);

              } else {
              let input;
              if (field.type === "select") {
                input = document.createElement("select");
                field.options.forEach(opt => {
                  const option = document.createElement("option");
                  option.value = opt.value;
                  option.textContent = opt.label;
                  if (opt.value === field.value) option.selected = true;
                  input.appendChild(option);
                });
                input.className = "setting-select";
              } else {
                input = document.createElement("input");
                input.type = ["storedFontColor", "storedBackgroundColor", "storedUserMsgBgColor", "storedAssistantMsgBgColor"].includes(field.key) ? "color" : "text";
                input.value = field.value;
                input.className = input.type === "color" ? "setting-color" : "setting-input";
              }
      
              input.addEventListener("change", async () => {
                const newValue = input.value.trim();
                switch (field.key) {
                  case "storedUserName": storedUserName = newValue || "‰Ω†"; break;
                  case "storedCharacterName": storedCharacterName = newValue || "Mistral"; break;
                  case "storedImageWidth": storedImageWidth = Number(newValue) || 800; break;
                  case "storedFontSize": storedFontSize = Number(newValue) || 16; break;
                  case "storedFontColor": storedFontColor = newValue || "#ffffff"; break;
                  case "storedBackgroundColor": storedBackgroundColor = newValue || "#000000"; break;
                  case "storedFontFamily": storedFontFamily = newValue || "Êñ∞Á¥∞ÊòéÈ´î"; break;
                  case "storedScreenshotStyle": storedScreenshotStyle = newValue; break;
                  case "storedUserMsgBgColor": storedUserMsgBgColor = newValue || "#313131"; break;
                  case "storedAssistantMsgBgColor": storedAssistantMsgBgColor = newValue || "#202020"; break;
                }
                await chrome.storage.local.set({ [field.key]: newValue });
              });
      
              groupContainer.appendChild(input);
            }
          });
      
          settingsContainer.appendChild(groupContainer);
        });
      
        settingsPanel.appendChild(settingsContainer);
      
        const btnContainer = document.createElement("div");
        btnContainer.style.marginTop = "10px";
        btnContainer.style.textAlign = "center";
      
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "ÂÑ≤Â≠ò";
        saveBtn.style.backgroundColor = "#4CAF50";
        saveBtn.style.color = "#fff";
        saveBtn.style.border = "none";
        saveBtn.style.borderRadius = "4px";
        saveBtn.style.padding = "6px 12px";
        saveBtn.style.cursor = "pointer";
        saveBtn.addEventListener("click", () => {
          document.body.removeChild(settingsPanel);
        });
      
        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "ÂèñÊ∂à";
        cancelBtn.style.backgroundColor = "#666";
        cancelBtn.style.color = "#fff";
        cancelBtn.style.border = "none";
        cancelBtn.style.borderRadius = "4px";
        cancelBtn.style.padding = "6px 12px";
        cancelBtn.style.cursor = "pointer";
        cancelBtn.style.marginLeft = "10px";
        cancelBtn.addEventListener("click", () => {
          document.body.removeChild(settingsPanel);
        });
      
        btnContainer.appendChild(saveBtn);
        btnContainer.appendChild(cancelBtn);
        settingsPanel.appendChild(btnContainer);
        document.body.appendChild(settingsPanel);
      }  

    //htmlËΩâÊèõÈñãÂßã
      /**
     * Áî® Fetch ÊäìÂèñÂúñÁâá‰∏¶ËΩâÊàê Base64 Data URI
     * @param {string} url - ÂúñÁâáÁöÑ URL
     * @returns {Promise<string>} ÂõûÂÇ≥ Base64 Ë≥áÊñô URI
     */
      async function fetchAsBase64(url) {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = () => reject("ËÆÄÂèñÂúñÁâáÂ§±Êïó");
            reader.readAsDataURL(blob);
          });
        } catch (err) {
          console.error("Fetch Â§±ÊïóÔºö", err);
          throw err;
        }
      }
        /**
       * ÊõøÊèõ container Ë£°ÊâÄÊúâ <img> ÁöÑ src Â±¨ÊÄßÁÇ∫ Base64 Data URIÔºà‰ΩøÁî® fetchÔºâ
       * @param {HTMLElement} container - ÁõÆÊ®ôÂÆπÂô®
       * @returns {Promise<void>}
       */
      async function replaceImagesWithBase64(container) {
        const images = container.querySelectorAll("img");
        await Promise.all([...images].map(async (img) => {
          if (img.src.startsWith("data:")) return;
          try {
            img.crossOrigin = "anonymous";
            const dataURL = await fetchAsBase64(img.src);
            img.src = dataURL;
            console.log("ÂúñÁâáÂ∑≤ËΩâ Base64Ôºö", dataURL.slice(0, 40) + "...");
            } catch (err) {
        console.error("ËΩâÊèõÂúñÁâáÂ§±ÊïóÔºö", err);
        }
      }))};
      /**
       * Âêå‰∏ÄÂâáË®äÊÅØË£°ÔºåÂ¶ÇÊûúÂá∫ÁèæÁõ∏ÂêåÁöÑÂúñÁâáÔºåÂè™‰øùÁïôÁ¨¨‰∏ÄÂºµÔºåÂÖ∂È§òÁßªÈô§
       * @param {HTMLElement} container - ÁõÆÊ®ôÂÆπÂô®
       */
      function removeDuplicateImages(container) {
        const images = container.querySelectorAll("img");
        const srcSet = new Set();
        images.forEach((img) => {
          if (srcSet.has(img.src)) {
            img.remove();
          } else {
            srcSet.add(img.src);
          }
        });
      }
      
      async function triggerImageConversion(options = {}) {
        const { splitMode = false, maxHeight = 4096, containerElem: passedContainer } = options;
        let containerElem = passedContainer;
        if (!containerElem) {
          const firstSelected = conversationData.find(m => m.selected);
          if (firstSelected) containerElem = firstSelected.element.parentElement;
        }
        if (!containerElem) {
          // ÈáùÂ∞ç Mistral Â∞ãÊâæÂ∞çË©±ÂÆπÂô®
          containerElem = document.querySelector('div[data-message-author-role="user"], div[data-message-part-type="answer"]')?.parentElement;
        }
        if (!containerElem) {
          console.error("Êâæ‰∏çÂà∞Â∞çË©±ÂÆπÂô® (triggerImageConversion)");
          return;
        }

        // ÂÖàÂ∞áÂúñÁâáËΩâÁÇ∫ Base64 ‰∏¶ÁßªÈô§ÈáçË§áÂúñÁâá
        await replaceImagesWithBase64(containerElem);
        removeDuplicateImages(containerElem);

        // ËôïÁêÜÊØèÂÄãË®äÊÅØÁöÑ HTML Âíå Markdown
        conversationData.forEach(msg => {
          const original = msg.element;
          const cloned = original.cloneNode(true);
        
          // ÁßªÈô§‰∏çÈúÄË¶ÅÁöÑÂÖÉÁ¥†ÔºàÊåâÈàï„ÄÅË§áË£ΩÂúñÁ§∫Á≠âÔºâ
          cloned.querySelectorAll("button, .copy, .lucide, svg").forEach(el => el.remove());
        
          // ÂúñÁâáËôïÁêÜÔºöÊääÂéüÂßãÂúñÁâáÔºàÂ∑≤ËΩâ base64ÔºâÂ°ûÂõû cloned
          const originalImgs = original.querySelectorAll("img");
          const clonedImgs = cloned.querySelectorAll("img");
          clonedImgs.forEach((img, i) => {
            if (originalImgs[i]) img.src = originalImgs[i].src;
          });
        
          // ÈáùÂ∞ç Mistral ÁöÑÂÖßÂÆπËôïÁêÜ
          let contentDiv = cloned;
          if (msg.role === "assistant") {
            // Â∞çÊñºÂä©ÁêÜË®äÊÅØÔºåÂ∞ãÊâæ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü
            const proseDiv = cloned.querySelector('.prose');
            if (proseDiv) contentDiv = proseDiv;
          }
        
          msg.html = contentDiv ? contentDiv.innerHTML : "<p>ÔºàÂÖßÂÆπÊ∂àÂ§±ÊÉπ QQÔºâ</p>";
          msg.markdown = getMarkdownFromMessage(contentDiv || cloned, msg.role === "user");
        });
        
        window.__cocoCatchSplitMode = splitMode;
        window.__cocoCatchMaxHeight = maxHeight;
      }

      /*****************************************
       * ÂåØÂá∫ÂäüËÉΩÔºöÊî∂ÈõÜÂ∞çË©±ÂæåÔºå‰∫§Áµ¶ background Â±§ËôïÁêÜ
       *****************************************/
      async function doExport() {
        await scanConversation();
        let selectedMessages = conversationData.filter(m => m.selected);
        if (selectedMessages.length === 0) {
          alert("Ê≤íÊúâÁ¨¶ÂêàÁØ©ÈÅ∏Ê¢ù‰ª∂ÁöÑË®äÊÅØÔºÅ");
          return;
        }
        const isImageExport = (storedFormat === "image");
        const MAX_HEIGHT = 4096;
        let splitMode = false;
      
        if (isImageExport) {
          // Âè™Ë®àÁÆóÈÅ∏ÂèñÂçÄÊÆµÁöÑÈ´òÂ∫¶
          const totalHeight = selectedMessages.reduce((h, m) => h + (m.element?.offsetHeight || 0), 0);
          if (totalHeight > MAX_HEIGHT) {
            const ok = window.confirm(`ÈÅ∏ÂèñÁöÑË®äÊÅØÈ´òÂ∫¶ ${totalHeight}px Â∑≤Ë∂ÖÈÅé ${MAX_HEIGHT}pxÔºåÂ∞áËá™ÂãïÂàÜÂºµ‰∏¶Â£ìÁ∏Æ‰∏ãËºâÔºåÁ¢∫ÂÆöÂóéÔºü`);
            if (!ok) return;
            splitMode = true;
          }
        }
        await triggerImageConversion({ splitMode, maxHeight: MAX_HEIGHT });
        
        // Âª∫Á´ã sanitizedDataÔºå‰∏çÂåÖÂê´ element Â±¨ÊÄß
        const sanitizedData = selectedMessages.map(m => {
          return {
            id: m.id,
            role: m.role,
            // ÂåØÂá∫Áî®ÔºöÂâçÈù¢Âä†‰ΩøÁî®ËÄÖËá™Ë®ÇÂêçÁ®±
            text: `${m.role === "user" ? storedUserName : storedCharacterName}Ôºö${m.markdown}`,
            // Êà™ÂúñÁî®Ôºö‰øùÊåÅÁ¥îÂéüÊñáÁµ¶ marked Ëß£Êûê
            markdown: m.markdown,
            selected: m.selected,
          };
        });
      
        const payload = {
          conversationData: sanitizedData,
          settings: {
            splitMode,
            maxHeight: MAX_HEIGHT,
            storedFormat,
            storedUserName,
            storedCharacterName,
            storedImageWidth,
            storedFontSize,
            storedFontColor,
            storedBackgroundColor,
            storedFontFamily,
            storedUserAvatar,
            storedAssistantAvatar,
            storedScreenshotStyle,
            storedUserMsgBgColor,
            storedAssistantMsgBgColor,
            fileNameBase: document.title
          }
        };
      
        try {
          // Áõ¥Êé•Âú®content script‰∏≠Âü∑Ë°åÂåØÂá∫ÈÇèËºØ
          const result = await handleExport(sanitizedData, payload.settings);
          console.log("ÂåØÂá∫ÂÆåÊàê:", result);
        } catch (error) {
          console.error("ÂåØÂá∫Â§±Êïó:", error);
        }
      }
      
      // Âπ´Ë®äÊÅØÂä†ÂÖ•ÂãæÈÅ∏Ê°Ü
      function addCheckboxToMessage(article, msgId) {
        if (article.querySelector(`[data-msg-id="${msgId}"]`)) return;
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.className = "chat-export-checkbox";
        chk.setAttribute("data-msg-id", msgId);
        const msg = conversationData.find(m => m.id === msgId);
        chk.checked = !!(msg && msg.selected);
        chk.style.position = "absolute";
        chk.style.right = "-100px";
        chk.style.top = "10px";
        chk.style.zIndex = "1000";
        chk.addEventListener("change", () => {
          const changingMsg = conversationData.find(m => m.id === msgId);
          if (changingMsg) changingMsg.selected = chk.checked;
        });
        article.style.position = "relative";
        article.appendChild(chk);
      }

      // ÂÖ®Êñ∞ÁöÑÂïüÂãïÂíåÁõ£ËÅΩÈÇèËºØÔºåÈáùÂ∞ç Mistral Ë™øÊï¥
      const mainObserver = new MutationObserver(async (mutations) => {
        const hasRelevantChanges = mutations.some(m => m.type === 'childList' && m.addedNodes.length > 0);
        if (hasRelevantChanges) {
          await scanConversation();
        }
      });

      // ‰ΩøÁî® setInterval Á¢∫‰øùÊì¥ÂÖÖÂäüËÉΩÂú®È†ÅÈù¢ÂàáÊèõÂæåËÉΩÊ≠£Á¢∫ÂïüÂãï
      let startupInterval = setInterval(() => {
        const mainElem = document.querySelector("main");
        // ÈáùÂ∞ç Mistral ËÅäÂ§©ÂÆ§ÁöÑÁâπÊÆäÂÖÉÁ¥†Ê™¢Êü•
        const chatArea = document.querySelector('div[data-message-author-role="user"], div[data-message-part-type="answer"]');

        if (mainElem && chatArea) {
          console.log("‚úÖ Mistral UI is ready. Initializing exporter.");
          
          // È¶ñÊ¨°Âü∑Ë°å
          currentUrl = window.location.pathname;
          scanConversation();
          
          // ÂïüÂãï MutationObserver
          mainObserver.observe(mainElem, {
            childList: true,
            subtree: true,
          });
          
          // ÂÆåÊàêÂæåÊ∏ÖÈô§ Interval
          clearInterval(startupInterval);
        }
      }, 500);
    
    console.log('‚úÖ Mistral ÂåØÂá∫Â∑•ÂÖ∑ÂàùÂßãÂåñÂÆåÊàê');
  }

  // ‰∏ªÂü∑Ë°åÈÇèËºØ
  async function main() {
    try {
      const platform = await waitForPlatform();
      
      if (!platform) {
        console.log('üîç Êú™ÂÅµÊ∏¨Âà∞ÊîØÊè¥ÁöÑËÅäÂ§©Âπ≥Âè∞');
        return;
      }

      console.log(`üéØ ÂÅµÊ∏¨Âà∞Âπ≥Âè∞: ${platform}`);

      // Ê†πÊìöÂπ≥Âè∞ÂàùÂßãÂåñÂ∞çÊáâÈÇèËºØ
      switch (platform) {
        case 'chatgpt':
          await initChatGPT();
          break;
        case 'gemini':
          await initGemini();
          break;
        case 'mistral':
          await initMistralChat();
          break;
        default:
          console.error('‚ùå Êú™Áü•Âπ≥Âè∞:', platform);
      }

    } catch (error) {
      console.error('üí• ÂàùÂßãÂåñÊôÇÁôºÁîüÈåØË™§:', error);
    }
  }

  // URL ËÆäÊõ¥Áõ£ËÅΩ
  let lastUrl = window.location.href;
  function handleUrlChange() {
    if (window.location.href !== lastUrl) {
      lastUrl = window.location.href;
      setTimeout(main, 1000);
    }
  }

  const observer = new MutationObserver(handleUrlChange);
  observer.observe(document.body, { childList: true, subtree: true });
  window.addEventListener('popstate', handleUrlChange);

  // Âü∑Ë°å‰∏ªÁ®ãÂ∫è
  main();

})();